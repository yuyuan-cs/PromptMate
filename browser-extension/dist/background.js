(()=>{console.log("PromptMate 背景脚本已启动");const e=e=>new Promise(t=>chrome.storage.local.get(e,t));async function t(){await new Promise(e=>chrome.contextMenus.removeAll(()=>e())),chrome.contextMenus.create({id:"promptmate-main",title:"PromptMate",contexts:["all"]}),chrome.contextMenus.create({id:"pm-open-sidepanel",parentId:"promptmate-main",title:"打开侧边栏",contexts:["all"]});const t=await e(["prompts","usageRecords","categories"]),o=t.prompts||[],n=t.usageRecords||[],a=t.categories||[],s=o.filter(e=>!!e.isFavorite).slice(0,10);if(s.length){chrome.contextMenus.create({id:"pm-fav",parentId:"promptmate-main",title:"收藏",contexts:["all"]});for(const e of s)chrome.contextMenus.create({id:`pm-inject:${e.id}`,parentId:"pm-fav",title:e.title,contexts:["all"]})}const r=new Map,i=[...n].filter(e=>e.promptId).sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime());for(const e of i){const t=o.find(t=>t.id===e.promptId);if(t&&!r.has(t.id)&&r.set(t.id,t),r.size>=10)break}const c=Array.from(r.values());if(c.length){chrome.contextMenus.create({id:"pm-recent",parentId:"promptmate-main",title:"最近使用",contexts:["all"]});for(const e of c)chrome.contextMenus.create({id:`pm-inject:${e.id}`,parentId:"pm-recent",title:e.title,contexts:["all"]})}if(a.length){chrome.contextMenus.create({id:"pm-categories",parentId:"promptmate-main",title:"按分类",contexts:["all"]});for(const e of a.slice(0,8)){const t=`pm-cat:${e.id}`;chrome.contextMenus.create({id:t,parentId:"pm-categories",title:e.name,contexts:["all"]});const n=o.filter(t=>t.category===e.id).slice(0,10);for(const e of n)chrome.contextMenus.create({id:`pm-inject:${e.id}`,parentId:t,title:e.title,contexts:["all"]})}}}let o;chrome.runtime.onInstalled.addListener(async()=>{console.log("PromptMate 扩展已安装"),await t()}),chrome.runtime.onStartup?.addListener(async()=>{await t()}),chrome.storage.onChanged.addListener(async(n,a)=>{"local"===a&&((n.prompts||n.usageRecords||n.categories)&&await t(),(n.prompts||n.categories||n.settings)&&await async function(){((await e(["settings"])).settings||{}).autoExportOnChange&&(o&&clearTimeout(o),o=setTimeout(async()=>{try{const t=await async function(){const t=await e(["prompts","categories","settings"]),o={prompts:t.prompts||[],categories:t.categories||[],settings:t.settings||{},exportDate:(new Date).toISOString(),version:"1.0.0"};return JSON.stringify(o,null,2)}(),o=new Blob([t],{type:"application/json"}),n=URL.createObjectURL(o);try{await chrome.downloads.download({url:n,filename:"PromptMate/promptmate-sync.json",saveAs:!1,conflictAction:"overwrite"})}finally{setTimeout(()=>URL.revokeObjectURL(n),1e4)}}catch(e){console.warn("自动导出失败:",e)}},600))}())}),chrome.action.onClicked.addListener(e=>{console.log("工具栏图标被点击，打开侧边栏"),e.id&&chrome.sidePanel.open({tabId:e.id})}),chrome.contextMenus.onClicked.addListener((t,o)=>{if(console.log("右键菜单被点击:",t),!o?.id)return;if("promptmate-main"===t.menuItemId||"pm-open-sidepanel"===t.menuItemId)return void chrome.sidePanel.open({tabId:o.id});const n=String(t.menuItemId);if(n.startsWith("pm-inject:")){const t=n.split(":")[1];e(["prompts"]).then(e=>{const n=(e.prompts||[]).find(e=>e.id===t);n&&chrome.tabs.sendMessage(o.id,{type:"INJECT_TEXT",payload:{text:n.content}})})}}),chrome.commands.onCommand.addListener(t=>{if("open-promptmate"===t)return console.log("快捷键触发，打开侧边栏"),void chrome.tabs.query({active:!0,currentWindow:!0},e=>{e[0]?.id&&chrome.sidePanel.open({tabId:e[0].id})});"inject-last-prompt"===t&&(console.log("快捷键触发，直接注入最近使用的提示词"),chrome.tabs.query({active:!0,currentWindow:!0},async t=>{const o=t[0]?.id;if(!o)return;const n=await e(["usageRecords","prompts"]),a=n.usageRecords||[],s=n.prompts||[],r=[...a].filter(e=>!!e.promptId).sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime())[0];if(!r)return;const i=s.find(e=>e.id===r.promptId);i&&chrome.tabs.sendMessage(o,{type:"INJECT_TEXT",payload:{text:i.content}})}))}),chrome.runtime.onMessage.addListener((e,t,o)=>{console.log("收到消息:",e),o({success:!0,message:"PromptMate 演示版本"})})})();