(()=>{"use strict";console.log("PromptMate 背景脚本已启动");const e=e=>new Promise(t=>chrome.storage.local.get(e,t)),t=()=>new Promise(e=>chrome.contextMenus.removeAll(()=>e()));async function n(n){if(!(n.enhancedSettings||{}).enableContextMenu)return void await t();await t(),chrome.contextMenus.create({id:"promptmate-main",title:"PromptMate",contexts:["all"]}),chrome.contextMenus.create({id:"pm-open-sidepanel",parentId:"promptmate-main",title:"打开侧边栏",contexts:["all"]});const o=await e(["prompts","usageRecords","categories"]),a=o.prompts||[],i=o.usageRecords||[],s=o.categories||[],r=a.filter(e=>!!e.isFavorite).slice(0,10);if(r.length){chrome.contextMenus.create({id:"pm-fav",parentId:"promptmate-main",title:"收藏",contexts:["all"]});for(const e of r)chrome.contextMenus.create({id:`pm-inject:${e.id}`,parentId:"pm-fav",title:e.title,contexts:["all"]})}const c=new Map,m=[...i].filter(e=>e.promptId).sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime());for(const e of m){const t=a.find(t=>t.id===e.promptId);if(t&&!c.has(t.id)&&c.set(t.id,t),c.size>=10)break}const d=Array.from(c.values());if(d.length){chrome.contextMenus.create({id:"pm-recent",parentId:"promptmate-main",title:"最近使用",contexts:["all"]});for(const e of d)chrome.contextMenus.create({id:`pm-inject:${e.id}`,parentId:"pm-recent",title:e.title,contexts:["all"]})}if(s.length){chrome.contextMenus.create({id:"pm-categories",parentId:"promptmate-main",title:"按分类",contexts:["all"]});for(const e of s.slice(0,8)){const t=`pm-cat:${e.id}`;chrome.contextMenus.create({id:t,parentId:"pm-categories",title:e.name,contexts:["all"]});const n=a.filter(t=>t.category===e.id).slice(0,10);for(const e of n)chrome.contextMenus.create({id:`pm-inject:${e.id}`,parentId:t,title:e.title,contexts:["all"]})}}}let o;async function a(){console.log("Initializing PromptMate background script...");const t=(await e(["settings"])).settings||{};await n(t),function(t){t.enhancedSettings?.enableOmnibox&&(chrome.omnibox.onInputStarted.addListener(()=>{console.log("Omnibox input started")}),chrome.omnibox.onInputChanged.addListener(async(t,n)=>{n(((await e(["prompts"])).prompts||[]).filter(e=>e.title.toLowerCase().includes(t.toLowerCase())).map(e=>({content:e.id,description:e.title})))}),chrome.omnibox.onInputEntered.addListener(async(t,n)=>{const o=t,a=((await e(["prompts"])).prompts||[]).find(e=>e.id===o);if(!a)return;const[i]=await chrome.tabs.query({active:!0,currentWindow:!0});i?.id&&chrome.tabs.sendMessage(i.id,{type:"INJECT_TEXT",payload:{text:a.content}})}))}(t),function(e){e.enhancedSettings?.enablePageSummary&&console.log("Page summary feature enabled.")}(t),function(e){e.enhancedSettings?.enableAutoActivate&&console.log("Auto-activation feature enabled.")}(t)}chrome.runtime.onInstalled.addListener(()=>{console.log("PromptMate extension installed."),a()}),chrome.runtime.onStartup?.addListener(()=>{console.log("Browser startup."),a()}),chrome.storage.onChanged.addListener(async(t,i)=>{if("local"===i){if(t.settings&&(console.log("Settings changed, re-initializing..."),await a()),t.prompts||t.usageRecords||t.categories){console.log("Data changed, rebuilding context menus...");const t=(await e(["settings"])).settings||{};await n(t)}(t.prompts||t.categories||t.settings)&&await async function(){((await e(["settings"])).settings||{}).autoExportOnChange&&(o&&clearTimeout(o),o=setTimeout(async()=>{try{const t=await async function(){const t=await e(["prompts","categories","settings"]),n={prompts:t.prompts||[],categories:t.categories||[],settings:t.settings||{},exportDate:(new Date).toISOString(),version:"1.0.0"};return JSON.stringify(n,null,2)}(),n=new Blob([t],{type:"application/json"}),o=URL.createObjectURL(n);try{await chrome.downloads.download({url:o,filename:"PromptMate/promptmate-sync.json",saveAs:!1,conflictAction:"overwrite"})}finally{setTimeout(()=>URL.revokeObjectURL(o),1e4)}}catch(e){console.warn("自动导出失败:",e)}},600))}()}}),chrome.action.onClicked.addListener(e=>{console.log("工具栏图标被点击，打开侧边栏"),e.id&&chrome.sidePanel.open({tabId:e.id})}),chrome.contextMenus.onClicked.addListener((t,n)=>{if(console.log("右键菜单被点击:",t),!n?.id)return;if("promptmate-main"===t.menuItemId||"pm-open-sidepanel"===t.menuItemId)return void chrome.sidePanel.open({tabId:n.id});const o=String(t.menuItemId);if(o.startsWith("pm-inject:")){const t=o.split(":")[1];e(["prompts"]).then(e=>{const o=(e.prompts||[]).find(e=>e.id===t);o&&chrome.tabs.sendMessage(n.id,{type:"INJECT_TEXT",payload:{text:o.content}})})}}),chrome.commands.onCommand.addListener(t=>{if("open-promptmate"===t)return console.log("快捷键触发，打开侧边栏"),void chrome.tabs.query({active:!0,currentWindow:!0},e=>{e[0]?.id&&chrome.sidePanel.open({tabId:e[0].id})});"inject-last-prompt"===t&&(console.log("快捷键触发，直接注入最近使用的提示词"),chrome.tabs.query({active:!0,currentWindow:!0},async t=>{const n=t[0]?.id;if(!n)return;const o=await e(["usageRecords","prompts"]),a=o.usageRecords||[],i=o.prompts||[],s=[...a].filter(e=>!!e.promptId).sort((e,t)=>new Date(t.timestamp).getTime()-new Date(e.timestamp).getTime())[0];if(!s)return;const r=i.find(e=>e.id===s.promptId);r&&chrome.tabs.sendMessage(n,{type:"INJECT_TEXT",payload:{text:r.content}})}))}),chrome.runtime.onMessage.addListener((e,t,n)=>{console.log("收到消息:",e),n({success:!0,message:"PromptMate 演示版本"})})})();