(()=>{if(console.log("PromptMate 内容脚本已加载"),!window.__PROMPTMATE_INJECTED__){function e(e,t){return e===t||e.endsWith("."+t)}function t(e){if(!e)return!1;const t=e.tagName.toLowerCase();if("textarea"===t)return!0;if("input"===t){const t=e.type.toLowerCase();return["text","search","email","password","url",""].includes(t)}if("true"===e.contentEditable||""===e.contentEditable)return!0;if(e.isContentEditable)return!0;if("rich-textarea"===t)return!0;if(e.hasAttribute("data-placeholder"))return!0;if("textbox"===e.getAttribute("role"))return!0;const n=e.className||"";return!!(n.includes("editor")||n.includes("input")||n.includes("textarea")||n.includes("ql-editor"))}function n(e){const t=window.getComputedStyle(e);return"none"!==t.display&&"hidden"!==t.visibility&&"0"!==t.opacity&&e.offsetWidth>0&&e.offsetHeight>0}function o(e){const t=document.createElement("div");t.style.cssText="\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: #333;\n      color: white;\n      padding: 12px 20px;\n      border-radius: 6px;\n      font-family: Arial, sans-serif;\n      font-size: 14px;\n      z-index: 10000;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n      max-width: 300px;\n      animation: slideIn 0.3s ease-out;\n    ";const n=document.createElement("style");n.textContent="\n      @keyframes slideIn {\n        from { transform: translateX(100%); opacity: 0; }\n        to { transform: translateX(0); opacity: 1; }\n      }\n    ",document.head.appendChild(n),t.textContent=e,document.body.appendChild(t),setTimeout(()=>{t.parentNode&&(t.style.animation="slideIn 0.3s ease-out reverse",setTimeout(()=>t.remove(),300)),n.remove()},3e3)}window.__PROMPTMATE_INJECTED__=!0,chrome.runtime.onMessage.addListener((r,s,a)=>(console.log("内容脚本收到消息:",r),"INJECT_TEXT"===r.type?(async()=>{const{allowed:s,reason:i}=await async function(){const{allowList:t=[],blockList:n=[]}=await async function(){try{return(await chrome.storage.local.get(["settings"])).settings||{}}catch(e){return console.warn("读取设置失败，使用默认空设置",e),{}}}(),o=location.hostname;return t.length>0?t.some(t=>e(o,t))?{allowed:!0}:{allowed:!1,reason:"当前站点不在白名单中"}:n.length>0&&n.some(t=>e(o,t))?{allowed:!1,reason:"当前站点在黑名单中"}:{allowed:!0}}();if(!s)return o(`已阻止注入：${i}`),void a({success:!1,error:i||"域名未允许"});const l=r.payload.text,c=function(){console.log("开始查找可编辑元素...");const e=document.activeElement;if(console.log("当前焦点元素:",e),e&&t(e))return console.log("找到焦点输入框:",e),e;const o=['input[type="text"]','input[type="search"]','input[type="email"]','input[type="password"]','input[type="url"]',"input:not([type])","textarea",'[contenteditable="true"]','[contenteditable=""]',".ql-editor",".ProseMirror",".ace_text-input",".CodeMirror textarea","rich-textarea","[data-placeholder]",".ql-blank",'[role="textbox"]','[data-testid*="input"]','[aria-label*="输入"]','[aria-label*="input"]','[aria-label*="Ask"]','[aria-label*="Type"]','[aria-label*="Enter"]',"[placeholder]","[contenteditable]",".input",".textarea",".editor"];for(const e of o){console.log(`尝试选择器: ${e}`);const o=document.querySelectorAll(e);console.log(`找到 ${o.length} 个元素`);for(const e of o){const o=e;if(console.log("检查元素:",{tagName:o.tagName,className:o.className,id:o.id,contentEditable:o.contentEditable,isEditable:t(o),isVisible:n(o)}),t(o)&&n(o))return console.log("找到可用输入框:",o),o}}console.log("尝试查找任何可能的输入元素...");const r=document.querySelectorAll("*");for(const e of r){const t=e;if((t.isContentEditable||"INPUT"===t.tagName&&!["button","submit","reset","checkbox","radio"].includes(t.type))&&n(t))return console.log("找到备用输入元素:",t),t}return console.log("未找到任何可用的输入框"),null}();if(c){const e=function(e,t){try{console.log("尝试注入文本到元素:",e);const n=e.tagName.toLowerCase();if("input"===n||"textarea"===n){const n=e;console.log("注入到标准输入框"),n.focus(),n.value,n.value=t,["focus","input","change","keyup","paste","blur"].forEach(e=>{n.dispatchEvent(new Event(e,{bubbles:!0}))});const o=Object.getOwnPropertyDescriptor(HTMLInputElement.prototype,"value")||Object.getOwnPropertyDescriptor(HTMLTextAreaElement.prototype,"value");return o&&o.set&&(o.set.call(n,t),n.dispatchEvent(new Event("input",{bubbles:!0}))),console.log("文本已注入到标准输入框:",t.substring(0,50)),!0}if(e.isContentEditable||"true"===e.contentEditable||""===e.contentEditable){if(console.log("注入到可编辑元素"),e.focus(),e.innerText,e.innerText=t,e.innerText!==t&&(e.textContent=t),e.innerText!==t&&e.textContent!==t&&(e.innerHTML=t.replace(/\n/g,"<br>")),e.innerText!==t){const n=window.getSelection(),o=document.createRange();o.selectNodeContents(e),n?.removeAllRanges(),n?.addRange(o),document.execCommand("insertText",!1,t)}return["focus","input","change","keyup","paste","blur"].forEach(t=>{e.dispatchEvent(new Event(t,{bubbles:!0}))}),console.log("文本已注入到可编辑元素:",t.substring(0,50)),!0}return"rich-textarea"===n?(console.log("注入到Gemini rich-textarea"),e.focus(),"value"in e&&(e.value=t),e.innerText=t,["focus","input","change","keyup","paste"].forEach(t=>{e.dispatchEvent(new Event(t,{bubbles:!0}))}),console.log("文本已注入到Gemini组件:",t.substring(0,50)),!0):(console.log("尝试通用注入方法"),e.focus(),"value"in e&&(e.value=t),void 0!==e.innerText&&(e.innerText=t),void 0!==e.textContent&&(e.textContent=t),["focus","input","change","keyup","paste"].forEach(t=>{e.dispatchEvent(new Event(t,{bubbles:!0}))}),console.log("尝试通用注入完成"),!0)}catch(e){return console.error("注入文本时出错:",e),!1}}(c,l);e?(c.focus(),a({success:!0,message:"文本注入成功"})):a({success:!1,error:"文本注入失败"})}else o("未找到可编辑的输入框，请先点击一个输入框"),a({success:!1,error:"未找到可编辑元素"})})():a({success:!1,error:"未知消息类型"}),!0)),console.log("PromptMate 内容脚本初始化完成")}})();