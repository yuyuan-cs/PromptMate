# 新建提示词行为统一修复说明

## 问题描述

用户反馈：侧边栏点击新建后，表单正常显示，但是在提示词列表中新建时，分类是当前激活的，这两个不同场景的同一个功能存在冲突。

## 问题分析

### 原始行为不一致

#### 场景1：侧边栏右键新建
- **触发方式**：右键点击分类文件夹
- **代码实现**：
  ```typescript
  // Sidebar.tsx
  <CreatePromptDialog
    options={{
      defaultCategory: newPromptCategoryId || undefined,  // 被右键点击的分类
    }}
  />
  ```
- **行为**：使用被右键点击的分类 ✅

#### 场景2：提示词列表新建
- **触发方式**：点击"新建提示词"按钮
- **代码实现**：
  ```typescript
  // PromptList.tsx
  <CreatePromptDialog
    options={{
      defaultCategory: categories[0]?.id || "general",  // 第一个分类
    }}
  />
  ```
- **行为**：使用第一个分类，忽略当前激活的分类 ❌

### 用户体验问题

1. **行为不一致**：同样的"新建提示词"功能，在不同位置有不同的默认分类
2. **用户困惑**：用户可能期望在提示词列表中新建时，使用当前激活的分类
3. **逻辑混乱**：右键点击分类时使用该分类，但普通新建时却忽略当前激活的分类

## 解决方案

### 统一行为规则

我建议统一为以下规则：

**优先级顺序**：
1. **明确指定的分类**（如右键菜单传递的分类）
2. **当前激活的分类**（`activeCategory`）
3. **第一个可用分类**
4. **默认分类**（"general"）

### 修复实现

#### 1. 侧边栏右键新建（保持不变）
```typescript
// Sidebar.tsx - 保持原有逻辑
<CreatePromptDialog
  options={{
    defaultCategory: newPromptCategoryId || undefined,  // 被右键点击的分类
  }}
/>
```

#### 2. 提示词列表新建（修复）
```typescript
// PromptList.tsx - 修复后的逻辑
<CreatePromptDialog
  options={{
    defaultCategory: activeCategory || categories[0]?.id || "general",
    // 优先使用当前激活的分类
  }}
/>
```

#### 3. usePromptForm 中的处理逻辑
```typescript
// usePromptForm.ts - 统一的分类选择逻辑
const getDefaultCategory = () => {
  if (initialData?.category) return initialData.category;      // 1. 明确指定
  if (defaultCategory) return defaultCategory;                 // 2. 传递的默认分类
  if (activeCategory) return activeCategory;                   // 3. 当前激活分类
  if (categories[0]?.id) return categories[0].id;              // 4. 第一个分类
  return "general";                                             // 5. 默认分类
};
```

## 修复后的行为

### 场景1：侧边栏右键新建
- **用户操作**：右键点击"开发编程"分类
- **系统行为**：新建提示词默认分类为"开发编程"
- **用户体验**：符合用户期望 ✅

### 场景2：提示词列表新建
- **用户操作**：当前激活"生产力"分类，点击"新建提示词"按钮
- **系统行为**：新建提示词默认分类为"生产力"
- **用户体验**：符合用户期望 ✅

### 场景3：无激活分类时新建
- **用户操作**：没有激活任何分类，点击"新建提示词"按钮
- **系统行为**：新建提示词默认分类为第一个可用分类
- **用户体验**：合理的回退行为 ✅

## 分类优先级规则

修复后的统一优先级（从高到低）：

1. **initialData.category**：编辑模式时的原始分类
2. **defaultCategory**：通过参数明确指定的分类（如右键菜单）
3. **activeCategory**：当前激活的分类
4. **categories[0].id**：第一个可用分类
5. **"general"**：默认分类

## 测试场景

### 测试1：侧边栏右键新建
1. 右键点击"开发编程"分类
2. 选择"新建提示词"
3. 验证分类字段显示"开发编程"

### 测试2：提示词列表新建（有激活分类）
1. 点击激活"生产力"分类
2. 点击"新建提示词"按钮
3. 验证分类字段显示"生产力"

### 测试3：提示词列表新建（无激活分类）
1. 确保没有分类被激活
2. 点击"新建提示词"按钮
3. 验证分类字段显示第一个可用分类

### 测试4：编辑模式
1. 编辑现有提示词
2. 验证分类字段保持原有分类不变

## 用户体验改进

### 修复前的问题
- ❌ 行为不一致：不同位置的新建功能有不同的默认分类
- ❌ 用户困惑：提示词列表新建时忽略当前激活的分类
- ❌ 逻辑混乱：右键点击分类时使用该分类，但普通新建时却忽略当前激活的分类

### 修复后的改进
- ✅ 行为一致：所有新建功能都遵循统一的分类选择规则
- ✅ 用户友好：提示词列表新建时使用当前激活的分类
- ✅ 逻辑清晰：优先级明确，行为可预测

## 相关文件

- `src/components/Sidebar.tsx` - 侧边栏组件（右键菜单）
- `src/components/PromptList.tsx` - 提示词列表组件（新建按钮）
- `src/hooks/usePromptForm.ts` - 表单管理Hook（统一逻辑）

## 更新日期

2025-01-27


