# PromptMate 安装方式优化说明

## 概述

本次优化全面改进了 PromptMate 在 Windows 环境下的安装体验，支持自定义安装路径、数据目录选择、智能更新策略等功能。

## 主要优化内容

### 1. 安装器类型优化

#### 1.1 新增 NSIS 安装器
- **功能**: 替换原有的便携版安装方式，提供标准的 Windows 安装体验
- **特性**:
  - 支持自定义安装路径
  - 提供安装向导界面
  - 支持组件选择安装
  - 自动创建桌面和开始菜单快捷方式
  - 支持卸载程序

#### 1.2 多种安装方式
- **标准安装**: 推荐的默认安装方式
- **自定义安装**: 用户可选择安装位置和组件
- **便携安装**: 保留便携版功能，无需注册到系统

### 2. 自定义数据目录支持

#### 2.1 数据目录选择
- **默认位置**: `%APPDATA%\PromptMate`
- **自定义位置**: 用户可选择任意位置作为数据保存目录
- **注册表存储**: 自定义路径保存在注册表 `HKCU\Software\PromptMate\DataDirectory`

#### 2.2 数据迁移功能
- **自动检测**: 安装时检测现有数据目录
- **迁移提示**: 询问用户是否迁移现有数据到新位置
- **备份保护**: 自动备份原有数据

#### 2.3 应用程序适配
- **主进程适配**: `main.cjs` 自动读取自定义数据路径
- **同步管理器适配**: `syncManager.ts` 支持自定义数据路径
- **跨平台兼容**: 仅在 Windows 平台启用，其他平台使用默认路径

### 3. 智能更新策略

#### 3.1 更新类型识别
- **主要更新 (Major)**: 用户确认后下载，重要功能变更
- **次要更新 (Minor)**: 自动下载，新功能添加
- **补丁更新 (Patch)**: 自动下载，问题修复

#### 3.2 静默更新机制
- **自动下载**: 次要和补丁更新自动在后台下载
- **托盘通知**: 仅在系统托盘显示更新状态
- **智能安装**: 应用退出时自动安装更新

#### 3.3 用户选择权
- **跳过版本**: 用户可选择跳过特定版本的更新
- **稍后提醒**: 30分钟后再次提醒更新
- **立即安装**: 用户可选择立即重启安装

#### 3.4 热更新支持
- **覆盖安装**: 更新时保留用户数据和设置
- **自动重启**: 安装完成后自动启动新版本
- **数据保护**: 更新过程中确保数据安全

### 4. 多语言安装界面

#### 4.1 语言支持
- **中文界面**: 完整的简体中文安装向导
- **英文界面**: 标准英文安装界面
- **自动检测**: 根据系统语言自动选择界面语言

#### 4.2 界面优化
- **现代UI**: 使用 Modern UI 2.0 风格
- **图标优化**: 统一的应用图标样式
- **交互改进**: 清晰的操作提示和说明

### 5. 安装组件管理

#### 5.1 可选组件
- **主程序**: 必须安装的核心文件
- **桌面快捷方式**: 可选择是否创建
- **开始菜单快捷方式**: 可选择是否创建
- **开机自启动**: 可选择是否开机自动运行

#### 5.2 卸载选项
- **保留数据**: 卸载时可选择保留用户数据
- **完全清理**: 可选择删除所有数据和注册表项
- **智能检测**: 自动检测和清理相关文件

## 技术实现

### 1. Electron Builder 配置

```json
{
  "win": {
    "target": [
      { "target": "nsis", "arch": ["x64"] },
      { "target": "portable", "arch": ["x64"] }
    ],
    "nsis": {
      "oneClick": false,
      "allowElevation": true,
      "allowToChangeInstallationDirectory": true,
      "createDesktopShortcut": true,
      "createStartMenuShortcut": true,
      "runAfterFinish": true,
      "deleteAppDataOnUninstall": false,
      "displayLanguageSelector": true,
      "installerLanguages": ["zh_CN", "en_US"]
    }
  }
}
```

### 2. NSIS 脚本特性

- **自定义页面**: 安装类型选择、数据目录配置
- **注册表操作**: 存储和读取自定义设置
- **文件操作**: 数据迁移和备份功能
- **多语言字符串**: 完整的本地化支持

### 3. 应用程序适配

#### 主进程数据路径获取
```javascript
function getCustomDataPath() {
  if (process.platform === 'win32') {
    try {
      const result = execSync('reg query "HKCU\\Software\\PromptMate" /v DataDirectory');
      const match = result.match(/DataDirectory\s+REG_SZ\s+(.+)/);
      if (match && match[1] && fs.existsSync(match[1].trim())) {
        return match[1].trim();
      }
    } catch (error) {
      console.log('未找到自定义数据路径，使用默认路径');
    }
  }
  return app.getPath('userData');
}
```

## 用户使用指南

### 1. 安装流程

1. **下载安装包**: 从 GitHub Releases 下载 `PromptMate Setup x.x.x.exe`
2. **运行安装程序**: 双击安装包启动安装向导
3. **选择语言**: 系统自动检测或手动选择界面语言
4. **选择安装类型**: 标准安装、自定义安装或便携安装
5. **配置数据目录**: 选择用户数据保存位置
6. **选择组件**: 选择要安装的组件和快捷方式
7. **完成安装**: 确认设置并开始安装

### 2. 数据目录说明

- **默认位置**: `C:\Users\[用户名]\AppData\Roaming\PromptMate`
- **推荐自定义位置**: 
  - `D:\PromptMate\Data` (独立磁盘)
  - `C:\PromptMate\Data` (系统盘独立文件夹)
- **注意事项**: 确保选择的位置有足够的磁盘空间

### 3. 更新体验

- **自动检查**: 应用启动时自动检查更新
- **后台下载**: 小版本更新自动在后台下载
- **用户控制**: 主要更新需要用户确认
- **数据安全**: 更新过程中用户数据完全保留

## 兼容性说明

### 1. 系统要求
- **操作系统**: Windows 10 或更高版本
- **架构**: x64 (64位)
- **权限**: 标准用户权限（可选择管理员权限）

### 2. 向后兼容
- **数据格式**: 与之前版本完全兼容
- **设置保留**: 升级时保留所有用户设置
- **插件兼容**: 浏览器扩展无需重新安装

## 故障排除

### 1. 安装问题
- **权限不足**: 以管理员身份运行安装程序
- **杀毒软件**: 暂时关闭杀毒软件或添加信任
- **磁盘空间**: 确保安装位置有足够空间

### 2. 数据目录问题
- **路径错误**: 检查自定义路径是否存在且可写
- **迁移失败**: 手动复制数据文件到新位置
- **权限问题**: 确保对数据目录有读写权限

### 3. 更新问题
- **网络连接**: 检查网络连接和防火墙设置
- **下载失败**: 手动从 GitHub 下载更新包
- **安装失败**: 关闭应用后手动运行安装程序

## 开发说明

### 1. 构建命令
```bash
# 构建 Windows 安装包
npm run dist:win

# 仅构建 NSIS 安装器
electron-builder --win nsis

# 仅构建便携版
electron-builder --win portable
```

### 2. 测试建议
- **虚拟机测试**: 在干净的 Windows 环境中测试安装
- **路径测试**: 测试各种自定义数据目录路径
- **更新测试**: 测试从旧版本升级的完整流程
- **卸载测试**: 验证卸载功能的完整性

### 3. 发布流程
1. 更新版本号
2. 构建安装包
3. 测试安装和更新
4. 发布到 GitHub Releases
5. 更新说明文档

## 未来计划

### 1. 功能增强
- **主题安装包**: 支持自定义主题的安装
- **插件管理**: 集成插件的安装和管理
- **云端配置**: 支持安装配置的云端同步

### 2. 平台扩展
- **macOS 优化**: 类似的 macOS 安装体验优化
- **Linux 支持**: 完善 Linux 平台的安装方式

### 3. 企业功能
- **批量部署**: 支持企业环境的批量安装
- **策略配置**: 支持组策略配置默认设置
- **集中管理**: 支持企业级的集中配置管理

---

*最后更新: 2025-01-04*
*版本: 1.1.8*

