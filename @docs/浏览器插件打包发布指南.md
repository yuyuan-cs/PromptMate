# PromptMate 浏览器插件打包发布指南

## 📦 打包流程

### 1. 环境准备

确保开发环境满足以下要求：

```bash
# 检查 Node.js 版本 (建议 >= 16.0.0)
node --version

# 检查 npm 版本
npm --version
```

### 2. 安装依赖

```bash
cd browser-extension
npm install
```

### 3. 构建生产版本

#### 方式一：基础构建
```bash
# 清理旧文件
npm run clean

# 构建生产版本
npm run build
```

#### 方式二：一键打包
```bash
# 构建并打包为 zip 文件
npm run pack
```

#### 方式三：自动化发布（推荐）
```bash
# 修复版本发布 (1.0.0 -> 1.0.1)
npm run release

# 小版本发布 (1.0.0 -> 1.1.0)
npm run release:minor

# 大版本发布 (1.0.0 -> 2.0.0)
npm run release:major
```

执行后会生成：
- `dist/` 文件夹：包含所有构建文件
- `promptmate-extension-vX.X.X.zip`：带版本号的发布包
- `dist/build-info.json`：构建信息文件

### 4. 验证构建结果

检查 `dist/` 文件夹是否包含以下文件：

```
dist/
├── manifest.json         # 扩展配置文件
├── background.js         # 后台脚本
├── content.js           # 内容脚本
├── popup.html           # 弹窗页面
├── popup.js             # 弹窗脚本
├── sidepanel.html       # 侧边栏页面
├── sidepanel.js         # 侧边栏脚本
├── options.html         # 设置页面
├── options.js           # 设置脚本
├── icons/               # 图标文件
│   ├── icon-16.png
│   ├── icon-32.png
│   ├── icon-48.png
│   └── icon-128.png
└── _locales/           # 国际化文件
    ├── en/
    │   └── messages.json
    └── zh_CN/
        └── messages.json
```

## 🔍 本地测试

### Chrome 浏览器测试

1. **打开扩展管理页面**
   ```
   chrome://extensions/
   ```

2. **启用开发者模式**
   - 点击右上角的"开发者模式"开关

3. **加载扩展**
   - 点击"加载已解压的扩展程序"
   - 选择 `browser-extension/dist` 文件夹

4. **测试功能**
   - 点击工具栏图标测试弹窗
   - 使用快捷键 `Ctrl+Shift+P` 测试
   - 在任意网页右键测试上下文菜单
   - 在输入框中测试内容注入

### Edge 浏览器测试

1. **打开扩展管理页面**
   ```
   edge://extensions/
   ```

2. **启用开发者模式**并加载扩展（步骤同Chrome）

## 🚀 发布到 Chrome Web Store

### 1. 准备发布材料

#### 扩展信息
- **名称**: PromptMate
- **简短描述**: AI提示词管理浏览器扩展
- **详细描述**: 准备详细的功能描述（见下方模板）
- **类别**: 生产工具
- **语言**: 中文（简体）、英语

#### 图标和截图
确保准备以下尺寸的图标：
- 16x16px (工具栏图标)
- 32x32px (扩展管理页面)
- 48x48px (扩展详情页面)
- 128x128px (Chrome Web Store)

截图要求：
- 至少1张，最多5张
- 1280x800px 或 640x400px
- 展示主要功能界面

#### 隐私政策
需要提供隐私政策链接，说明数据收集和使用情况。

### 2. 注册开发者账号

1. **访问 Chrome Web Store 开发者控制台**
   ```
   https://chrome.google.com/webstore/devconsole
   ```

2. **注册开发者账号**
   - 支付一次性注册费用 $5 USD
   - 验证身份信息

### 3. 上传扩展

1. **打包扩展**
   ```bash
   # 确保已构建最新版本
   npm run pack
   ```

2. **上传到控制台**
   - 在开发者控制台点击"新增项目"
   - 上传 `promptmate-extension.zip` 文件

3. **填写商店信息**
   - 扩展名称和描述
   - 上传图标和截图
   - 设置隐私政策链接
   - 选择定价（免费）

4. **提交审核**
   - 检查所有信息无误
   - 提交给 Google 审核

### 4. 审核过程

- **审核时间**: 通常 1-3 个工作日
- **可能要求**: 补充信息或修改内容
- **审核通过**: 扩展将在商店中可见

## 📋 发布清单

### 发布前检查

- [ ] 版本号已更新 (`manifest.json` 和 `package.json`)
- [ ] 所有功能正常工作
- [ ] 已移除调试代码和console.log
- [ ] 图标和截图准备完毕
- [ ] 隐私政策已准备
- [ ] 构建大小合理（< 2MB）

### 版本管理

```json
// manifest.json
{
  "manifest_version": 3,
  "name": "__MSG_extensionName__",
  "version": "1.0.0",  // 更新版本号
  "description": "__MSG_extensionDescription__"
}
```

```json
// package.json
{
  "name": "promptmate-browser-extension",
  "version": "1.0.0",  // 保持与manifest.json一致
}
```

## 🔄 更新发布

### 版本更新流程

1. **更新版本号**
   ```bash
   # 自动更新版本号
   npm version patch  # 修复版本 (1.0.0 -> 1.0.1)
   npm version minor  # 小版本 (1.0.0 -> 1.1.0)
   npm version major  # 大版本 (1.0.0 -> 2.0.0)
   ```

2. **构建新版本**
   ```bash
   npm run pack
   ```

3. **上传到 Chrome Web Store**
   - 在开发者控制台选择现有扩展
   - 上传新的zip文件
   - 填写更新说明
   - 提交审核

### 更新说明模板

```
版本 1.0.1 更新内容：

✨ 新功能：
- 添加了新的功能特性

🐛 问题修复：
- 修复了已知bug

⚡ 性能优化：
- 提升了运行效率

🎨 界面改进：
- 优化了用户体验
```

## 🛠️ 高级配置

### 自动化构建脚本

创建自动化构建脚本 `scripts/build-extension.js`：

```javascript
const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

// 读取当前版本
const packageJson = require('../browser-extension/package.json');
const manifestPath = path.join(__dirname, '../browser-extension/manifest.json');
const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));

// 同步版本号
manifest.version = packageJson.version;
fs.writeFileSync(manifestPath, JSON.stringify(manifest, null, 2));

// 构建
console.log('构建扩展...');
execSync('npm run build', { cwd: 'browser-extension', stdio: 'inherit' });

// 打包
console.log('打包扩展...');
execSync('npm run pack', { cwd: 'browser-extension', stdio: 'inherit' });

console.log(`✅ 扩展构建完成 - 版本 ${packageJson.version}`);
```

### 测试自动化

```bash
# 创建测试脚本
cat > scripts/test-extension.js << 'EOF'
// 自动化测试脚本
const puppeteer = require('puppeteer');

async function testExtension() {
  const browser = await puppeteer.launch({
    headless: false,
    args: [
      `--load-extension=${__dirname}/../browser-extension/dist`,
      '--disable-extensions-except=' + __dirname + '/../browser-extension/dist'
    ]
  });
  
  // 执行测试用例
  // ...
  
  await browser.close();
}

testExtension();
EOF
```

## 📊 发布统计

### 监控指标

可以通过 Chrome Web Store 开发者控制台监控：

- **安装量**: 总安装数
- **活跃用户**: 日活/周活用户
- **评分评论**: 用户反馈
- **崩溃报告**: 错误统计

### 分析工具

集成 Google Analytics 进行用户行为分析：

```javascript
// 在 background.js 中添加
chrome.runtime.onInstalled.addListener(() => {
  // 发送安装统计
  gtag('event', 'install', {
    event_category: 'extension',
    event_label: 'new_install'
  });
});
```

## 🔐 安全考虑

### 权限申请

确保只申请必要的权限：

```json
{
  "permissions": [
    "storage",        // 数据存储
    "contextMenus",   // 右键菜单
    "activeTab",      // 当前标签页
    "scripting",      // 脚本注入
    "sidePanel"       // 侧边栏
  ],
  "host_permissions": [
    "<all_urls>"      // 所有网站访问
  ]
}
```

### 内容安全策略

```json
{
  "content_security_policy": {
    "extension_pages": "script-src 'self'; object-src 'self';"
  }
}
```

## 🆘 常见问题

### Q: 扩展无法加载怎么办？
A: 检查以下几点：
1. 确保 `manifest.json` 格式正确
2. 检查所有引用的文件是否存在
3. 查看浏览器控制台错误信息

### Q: 如何处理版本兼容性？
A: 
1. 使用 Manifest V3 确保未来兼容性
2. 定期测试不同浏览器版本
3. 关注Chrome扩展API更新

### Q: 提交审核失败怎么办？
A:
1. 仔细阅读审核反馈
2. 修改相关问题后重新提交
3. 确保隐私政策完整准确

## 📝 相关文档

- [Chrome扩展开发文档](https://developer.chrome.com/docs/extensions/)
- [Manifest V3 迁移指南](https://developer.chrome.com/docs/extensions/migrating/)
- [Chrome Web Store 发布策略](https://developer.chrome.com/docs/webstore/)

---

**最后更新**: 2025年1月20日
**文档版本**: v1.0
