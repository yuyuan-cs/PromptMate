# 变量快捷编辑功能说明

## 概述

PromptMate 新增了智能变量识别与编辑功能，让用户可以轻松创建和管理包含变量的提示词模板，提高工作效率。

## 核心功能

### 1. 智能变量识别与高亮

#### 支持的变量格式
- **花括号格式**: `{variable}` - 最常用的变量格式
- **双花括号格式**: `{{variable}}` - 用于特殊场景
- **方括号格式**: `[variable]` - 适合某些特定用途
- **美元符号格式**: `$variable` - 类似编程语言的变量格式

#### 自动高亮显示
- 变量占位符自动以彩色高亮显示
- 不同格式使用不同的颜色区分
- 悬停时显示变量名称和详细信息
- 支持点击变量进行快速编辑

### 2. 变量填写表单自动生成

#### 智能表单生成
- 系统自动分析提示词内容
- 为每个变量生成对应的输入字段
- 提供友好的中文标签和占位符
- 支持必填字段验证

#### 表单特性
- **自动标签**: 根据变量名生成友好的中文标签
- **智能建议**: 基于变量名提供相关建议值
- **快速填充**: 一键填充示例值
- **批量操作**: 支持清空所有变量值

### 3. 变量建议与自动补全

#### 智能建议系统
- 基于变量名提供相关建议
- 支持常用值的快速选择
- 历史记录自动保存和复用
- 收藏夹功能，标记常用值

#### 自动补全功能
- 输入时自动显示相关建议
- 支持模糊搜索和过滤
- 快速选择历史使用过的值
- 智能排序，常用值优先显示

## 使用方法

### 1. 创建变量化提示词

#### 基本语法
```markdown
请帮我写一篇关于{title}的文章，主题是{topic}。

要求：
- 目标受众：{audience}
- 文章风格：{style}
- 语言：{language}
- 格式：{format}
- 字数：约{count}字
```

#### 变量命名建议
- 使用有意义的变量名：`title`、`topic`、`audience`
- 避免特殊字符和空格
- 保持命名一致性
- 使用小写字母和下划线

### 2. 使用变量表单

#### 预览模式集成
1. 在编辑器中输入包含变量的提示词
2. 在预览区域点击"填写变量"按钮
3. 系统自动识别所有变量占位符并生成表单
4. 填写变量后实时预览最终结果

#### 填写变量
1. 点击预览区域的"填写变量"按钮展开表单
2. 查看生成的表单字段
3. 为每个变量输入相应的值
4. 使用建议值快速填充
5. 实时预览变量替换后的内容

### 3. 预览和导出

#### 实时预览
- 填写变量后立即看到最终内容
- 支持 Markdown 格式渲染
- 变量替换后的完整预览

#### 导出功能
- 一键复制最终内容
- 支持多种格式导出
- 变量值可单独保存

## 组件说明

### 1. VariableForm 组件

### 2. VariableHighlighter 组件

#### 主要功能
- 在编辑器中高亮显示变量
- 支持点击交互
- 实时变量统计
- 多种显示模式

#### 使用示例
```tsx
<VariableHighlighter
  content={content}
  onVariableClick={handleVariableClick}
  highlightClassName="custom-highlight"
/>
```

### 3. 集成变量表单功能

#### 设计理念
- 将变量填写功能集成到预览模式中
- 编辑时不打断用户思路
- 预览时提供完整的变量管理功能

#### 主要功能
- 自动生成变量填写表单
- 提供智能建议和快速填充
- 实时预览和验证
- 原始内容和变量替换后的对比预览

#### 使用方式
```tsx
// 在预览区域点击"填写变量"按钮
// 系统自动展开变量填写表单
// 填写后实时预览最终结果
```

#### 优势
- 编辑和预览功能分离，界面更清晰
- 变量填写不影响编辑流程
- 支持原始内容和最终结果的对比
- 一键复制变量替换后的内容

### 4. AI配置按钮优化

#### 拖拽功能
- 支持拖拽移动按钮位置
- 可自定义默认位置
- 拖拽时显示视觉反馈

#### 右键菜单
- 右键点击显示上下文菜单
- 支持隐藏/显示按钮
- 提供拖拽状态指示

#### 隐藏状态
- 隐藏时显示小型提示按钮
- 提示信息："AI API未完成配置，可在设置中配置"
- 右键点击可重新显示按钮

#### 配置状态
- 未配置时显示"配置AI"按钮
- 已配置时显示"AI优化"按钮
- 支持内联和浮动两种显示模式

### 5. 变量填写表单布局优化

#### 精简布局设计
- 变量名称与输入框在同一行显示
- 移除冗余的状态标签，使用视觉化方式展示
- 优化间距和布局，提升空间利用率

#### 可视化状态显示
- 已填写变量：输入框边框变为绿色，背景变为浅绿色
- 待填写变量：保持默认样式，悬停时边框变蓝
- 通过颜色变化直观显示填写状态，无需额外标签

#### 预览功能增强
- 默认显示预览模式，提升用户体验
- 预览内容支持变量高亮显示
- 已填写的变量在预览中也会被高亮标识
- 支持复制预览内容功能

### 6. 可拖拽调节宽度的布局

#### 拖拽调节功能
- 使用 `ResizablePanelGroup` 实现左右分栏布局
- 左侧为提示词列表，右侧为编辑面板
- 中间拖拽手柄支持鼠标拖拽调节两栏宽度比例
- 拖拽手柄带有视觉指示器，提升用户体验

#### 布局配置
- 默认左右两栏各占 60% 和 40% 宽度
- 最小宽度限制：每栏不少于 30% 宽度
- 最大宽度限制：每栏不超过 70% 宽度
- 支持实时拖拽调节，即时生效

#### 响应式设计
- 当没有选中提示词时，列表区域自动占满全宽
- 两栏布局时，每栏内容支持独立滚动
- 拖拽操作流畅，支持触摸设备
- 保持原有的动画和过渡效果

### 7. 图片拖拽和粘贴上传功能

#### 拖拽上传功能
- 支持将图片文件直接拖拽到指定区域
- 拖拽过程中有视觉反馈（边框颜色变化、背景高亮）
- 自动过滤非图片文件，只接受图片格式
- 支持多文件同时拖拽上传

#### 粘贴上传功能
- 支持从剪贴板直接粘贴图片
- 自动识别剪贴板中的图片内容
- 无需保存图片文件，直接粘贴即可上传
- 提升用户操作效率

#### 文件验证
- 文件类型验证：只接受 JPG、PNG、GIF 等图片格式
- 文件大小限制：最大 10MB，防止过大文件影响性能
- 自动过滤无效文件，提供友好的错误提示

#### 用户体验优化
- 直观的拖拽区域设计，带有虚线边框和图标
- 拖拽过程中的实时视觉反馈
- 支持键盘快捷键操作
- 与现有图片上传逻辑完全兼容

### 8. AI配置状态实时检测

#### 状态检测机制
- 实时检测AI服务配置状态变化
- 每2秒自动检查配置更新
- 配置完成后自动切换按钮状态
- 无需手动刷新页面

#### 按钮状态管理
- **未配置状态**：显示"配置AI"按钮，引导用户配置
- **已配置状态**：显示"AI优化"按钮，提供优化功能
- **优化中状态**：显示加载动画和进度指示
- **状态切换**：配置完成后立即生效

#### 按钮位置和样式
- **内联模式**：位于内容输入框右下角，圆形小按钮
- **浮动模式**：位于页面右下角，大尺寸按钮
- **响应式设计**：根据内容长度自动调整按钮文字
- **视觉反馈**：悬停效果、动画效果、状态指示

#### 技术实现
- 使用 `useEffect` 和 `setInterval` 定期检查配置
- 监听 `aiService.isConfigured()` 状态变化
- 自动更新组件状态，确保UI同步
- 内存泄漏防护，组件卸载时清理定时器

### 9. 按钮布局优化和功能合并

#### 顶部工具栏整合
- **编辑/预览切换**：统一的模式切换按钮
- **收藏功能**：快速收藏/取消收藏提示词
- **复制功能**：智能复制，根据模式复制不同内容
- **保存功能**：手动保存未保存的更改
- **删除功能**：安全删除提示词

#### 智能复制功能
- **编辑模式**：复制原始提示词内容
- **预览模式**：复制变量填充后的最终内容
- **自动识别**：根据当前状态自动选择复制内容
- **用户友好**：tooltip 提示当前复制的内容类型

#### 变量操作按钮
- **位置优化**：从预览区域移动到顶部工具栏
- **填写变量**：显示/隐藏变量填写表单
- **重置变量**：快速清空所有已填写的变量值
- **状态同步**：与编辑状态保持同步

#### 布局结构优化
- **顶部区域**：主要操作按钮集中管理
- **预览区域**：专注于内容展示和变量填写
- **响应式设计**：在不同屏幕尺寸下保持良好的布局
- **视觉层次**：清晰的功能分组和视觉层次

### 10. 错误修复和稳定性提升

#### 控制台错误修复
- **TypeError 修复**：修复 `Cannot convert undefined or null to object` 错误
- **状态重置**：确保 `resetForm` 函数重置所有新增字段
- **安全检查**：添加 `variableValues` 的空值检查
- **默认值处理**：使用 `safeVariableValues` 确保组件稳定性

#### 状态管理优化
- **完整重置**：表单重置时包含所有状态字段
- **空值防护**：防止 `undefined` 或 `null` 值导致的错误
- **类型安全**：确保所有状态字段都有正确的初始值
- **错误边界**：添加运行时错误防护机制

#### 技术实现细节
- **useEffect 依赖**：正确管理状态变化的依赖关系
- **回调函数**：确保状态更新回调的正确执行
- **内存管理**：防止内存泄漏和状态不一致
- **错误处理**：优雅处理异常情况

### 11. React Hooks 规则修复

#### Hooks 使用规则
- **顺序一致性**：确保 hooks 在每次渲染时都以相同顺序调用
- **提前返回处理**：将条件逻辑移到 hooks 内部，避免提前返回
- **useMemo 优化**：在 useMemo 内部处理边界情况
- **类型安全**：使用 TypeScript 确保类型一致性

#### VariableHighlighter 修复
- **错误原因**：在 `useMemo` 之前有提前返回语句，违反 hooks 规则
- **解决方案**：将条件逻辑移到 `useMemo` 内部
- **性能优化**：保持原有的性能优化逻辑
- **代码结构**：更清晰的组件结构

#### 状态管理优化
- **变量值初始化**：确保 `variableValues` 始终有默认值
- **条件渲染**：修复重置变量按钮的显示逻辑
- **状态同步**：保持编辑和预览模式的状态一致

### 12. 复制功能提示修复

#### 复制功能优化
- **统一提示**：所有复制操作都显示 toast 提示
- **状态感知**：根据当前模式显示不同的提示信息
- **错误处理**：复制失败时显示错误提示
- **用户体验**：提供清晰的操作反馈

#### 复制逻辑改进
- **编辑模式**：复制原始内容，显示"提示词内容已复制到剪贴板"
- **预览模式**：复制最终内容（应用变量值后），显示"最终内容已复制到剪贴板"
- **错误情况**：复制失败时显示"无法复制到剪贴板，请手动复制"
- **成功反馈**：所有复制操作都有成功提示

#### 技术实现
- **Promise 处理**：使用 `.then()` 和 `.catch()` 处理剪贴板操作
- **Toast 集成**：集成现有的 toast 系统
- **状态检查**：根据 `state.isEditing` 和 `state.variableValues` 判断复制内容
- **依赖管理**：正确管理 `useCallback` 的依赖数组

### 13. 按钮界面优化

#### 图标按钮设计
- **视觉统一**：将文字按钮改为图标按钮，保持界面一致性
- **空间节省**：图标按钮占用更少空间，界面更紧凑
- **现代设计**：符合现代 UI 设计趋势，提升用户体验
- **图标语义**：使用语义化的图标，直观表达功能

#### 填写变量按钮重点展示
- **主要操作**：使用 `PenTool` 图标，表示精确编辑和填写功能
- **精美设计**：选择更精美且语义化的图标，提升视觉体验
- **渐变色效果**：使用蓝紫渐变色彩，更加吸引用户注意力
- **动态交互**：hover 时颜色加深、阴影增强、轻微缩放
- **视觉层次**：通过渐变和阴影突出主要操作按钮
- **交互反馈**：丰富的 hover 状态提供沉浸式体验

#### 重置变量按钮
- **次要操作**：使用 `RotateCcw` 图标，表示重置/刷新功能
- **条件显示**：只在有变量值时才显示，避免界面混乱
- **简洁设计**：保持简洁的 outline 样式，不抢夺主要按钮的注意力

#### Tooltip 提示系统
- **功能说明**：每个图标按钮都有对应的 tooltip 提示
- **用户友好**：新用户可以通过 tooltip 快速理解按钮功能
- **状态感知**：tooltip 内容根据当前状态动态变化
- **无障碍支持**：提升键盘和屏幕阅读器的可访问性

#### 技术实现细节
- **图标导入**：从 `lucide-react` 导入 `PenTool` 和 `RotateCcw` 图标
- **条件渲染**：根据 `state.showVariableForm` 和 `state.variableValues` 条件显示
- **样式管理**：使用 `cn` 工具函数管理条件样式
- **响应式设计**：按钮尺寸适配不同屏幕尺寸

#### 渐变色设计系统
- **主按钮渐变**：`from-blue-500 to-purple-600` 蓝紫渐变，现代感强
- **Hover 状态**：`hover:from-blue-600 hover:to-purple-700` 颜色加深
- **次要按钮**：`hover:from-gray-50 hover:to-blue-50` 淡雅渐变
- **动画效果**：`transition-all duration-300` 平滑过渡动画
- **交互反馈**：`hover:scale-105` 轻微缩放，`hover:shadow-xl` 阴影增强

### 14. 浮动标签和卡片式布局优化

#### 核心设计理念
- **紧凑清晰**：采用"浮动标签" + "卡片式布局"的设计，让每个变量字段都成为一个独立、清晰且空间占用小的模块
- **模块化设计**：每个变量字段独立成卡片，提升视觉层次和可操作性
- **现代交互**：引入浮动标签交互效果，提升用户体验的现代感
- **空间效率**：显著减少界面空间占用，提升信息密度

#### 浮动标签交互效果
- **动态定位**：标签在用户未输入时位于输入框中央，输入时上移到顶部
- **状态感知**：
  - **空闲状态**：标签居中显示，字体较大，颜色为 `text-muted-foreground`
  - **聚焦状态**：标签上移并缩小，颜色变为 `text-primary`
  - **填写状态**：标签保持上移位置，颜色为 `text-primary`
- **平滑动画**：使用 `transition-all duration-200` 实现平滑的位置和尺寸变化
- **视觉反馈**：清晰展示字段状态，用户可直观了解哪些字段已填写

#### 卡片式布局设计
- **独立卡片**：每个变量字段使用独立的 `Card` 组件包装
- **悬停效果**：鼠标悬停时边框颜色加深，提升交互反馈
- **内容组织**：
  - 输入区域在卡片内部，视觉更聚焦
  - 标签和输入框紧密结合，减少视觉干扰
  - 描述文本位于底部，提供必要的使用提示

#### 历史记录集成优化
- **固定位置**：历史记录下拉箭头固定在输入框右侧
- **清晰图标**：使用 `ChevronDown` 图标，符合用户直觉
- **智能禁用**：当没有历史记录时自动禁用按钮
- **快速访问**：点击下拉箭头即可查看和选择历史值
- **视觉一致**：与建议值选择器保持一致的设计风格

#### 空间优化效果
**修改前的传统布局**：
```
[标签区域: 80-120px] [输入框区域: 剩余空间] [按钮区域: 40px]
总高度：约 60-80px 每个字段
```

**修改后的紧凑布局**：
```
[卡片容器]
  [浮动标签 + 输入框 + 按钮] 
总高度：约 48-56px 每个字段 (节省 20-30% 空间)
```

#### 用户体验提升
- **学习成本降低**：浮动标签是现代Web应用的标准交互模式
- **填写效率提升**：紧凑布局让用户能在更小的视觉范围内完成操作
- **状态识别清晰**：通过动画和颜色变化直观展示字段状态
- **操作便捷性**：历史记录和建议值的快速访问提升填写效率

#### 技术实现细节
- **CSS Peer 选择器**：使用 `peer` 和 `peer-focus` 实现浮动标签效果
- **状态管理**：基于 `variableValues[field.name]` 判断标签位置
- **响应式设计**：在不同屏幕尺寸下保持良好的布局效果
- **无障碍支持**：保持 `Label` 和 `Textarea` 的关联，确保屏幕阅读器可访问性

#### 浏览器兼容性
- **现代浏览器**：完全支持 Chrome 88+、Firefox 85+、Safari 14+
- **CSS特性**：使用标准的 CSS 选择器和动画属性
- **渐进增强**：在不支持的浏览器中降级为传统布局，不影响功能使用

### 2. VariableHighlighter 组件

#### 主要功能
- 在编辑器中高亮显示变量
- 支持点击交互
- 实时变量统计
- 多种显示模式

#### 使用示例
```tsx
<VariableHighlighter
  content={content}
  onVariableClick={handleVariableClick}
  highlightClassName="custom-highlight"
/>
```

### 3. VariableTextArea 组件

#### 主要功能
- 增强的文本输入区域
- 实时变量高亮显示
- 变量统计信息
- 支持变量交互

#### 使用示例
```tsx
<VariableTextArea
  value={content}
  onChange={setContent}
  placeholder="输入提示词内容..."
  rows={8}
  showVariables={true}
/>
```

## 高级功能

### 1. 变量历史管理

#### 自动保存
- 每次使用变量值自动保存到历史记录
- 支持收藏夹功能
- 快速访问常用值

#### 历史记录
- 按变量名分类存储
- 支持搜索和过滤
- 自动清理过期记录

### 2. 变量统计分析

#### 使用统计
- 变量使用频率统计
- 变量类型分布分析
- 使用趋势跟踪

#### 优化建议
- 基于使用情况提供优化建议
- 识别未使用的变量
- 推荐更好的变量命名

### 3. 模板管理

#### 模板库
- 预定义常用提示词模板
- 支持自定义模板保存
- 模板分类和标签

#### 快速应用
- 一键加载模板
- 支持模板参数自定义
- 模板版本管理

## 最佳实践

### 1. 变量设计原则

#### 命名规范
- 使用描述性的变量名
- 保持命名一致性
- 避免过于复杂的变量名

#### 数量控制
- 单个提示词建议不超过 10 个变量
- 相关变量可以组合使用
- 避免过度参数化

### 2. 提示词结构

#### 清晰组织
- 使用标题和分段组织内容
- 变量按逻辑顺序排列
- 提供清晰的说明和示例

#### 灵活性设计
- 考虑不同使用场景
- 提供合理的默认值
- 支持可选参数

### 3. 用户体验

#### 友好提示
- 为每个变量提供清晰的说明
- 使用示例值帮助理解
- 提供相关的建议和选项

#### 快速操作
- 支持批量填充和清空
- 快捷键操作
- 智能记忆和推荐

## 技术实现

### 1. 变量识别算法

#### 正则表达式匹配
```typescript
const VARIABLE_PATTERNS = [
  /\{([^}]+)\}/g,           // {variable} 格式
  /\{\{([^}]+)\}\}/g,       // {{variable}} 格式
  /\[([^\]]+)\]/g,          // [variable] 格式
  /\$([a-zA-Z_][a-zA-Z0-9_]*)/g, // $variable 格式
];
```

#### 智能解析
- 支持嵌套和转义字符
- 自动去重和排序
- 位置信息精确记录

### 2. 表单生成逻辑

#### 集成表单
- 基于变量信息自动生成
- 集成在预览区域中
- 支持折叠/展开显示

#### 状态管理
- 变量值实时同步
- 表单验证和错误处理
- 预览内容实时更新

### 3. 预览系统

#### 实时渲染
- 变量替换算法
- Markdown 格式支持
- 性能优化和缓存

#### 交互功能
- 变量点击高亮
- 快速编辑和修改
- 导出和分享

## 故障排除

### 1. 常见问题

#### 变量不显示
- 检查变量格式是否正确
- 确认正则表达式匹配
- 查看控制台错误信息

#### 表单不生成
- 验证变量识别是否成功
- 检查组件是否正确导入
- 确认状态管理是否正常

#### 预览不更新
- 检查变量值变化监听
- 确认预览函数调用
- 验证数据流是否正确

#### 编码错误
- 如果遇到 "Unexpected character ''" 错误，可能是文件编码损坏
- 解决方案：重新创建文件或检查文件编码格式
- 确保使用 UTF-8 编码保存文件

#### 变量引用错误
- 如果遇到 "variable is not defined" 错误，可能是JSX中的变量引用问题
- 解决方案：使用HTML实体编码（如 &#123; 代替 {）来显示特殊字符
- 避免在JSX中直接使用可能被误解为JavaScript表达式的字符

#### 编辑模式变量显示
- 编辑模式下注释掉变量高亮显示，避免干扰用户创作
- 将 `VariableTextArea` 的 `showVariables` 设置为 `false`
- 注释掉 Markdown 预览，避免显示未填充的变量内容
- 变量填写功能完全移至预览模式

#### 变量高亮重复显示修复
- 修复了 `VariableHighlighter` 组件中文本重复显示的问题
- 原问题：倒序处理变量时逻辑错误，导致文本被重复处理
- 解决方案：改为顺序处理，使用 `lastIndex` 跟踪处理位置
- 确保每个文本片段只被处理一次，避免重复显示

### 2. 性能优化

#### 大文本处理
- 使用虚拟滚动
- 延迟渲染和更新
- 缓存计算结果

#### 内存管理
- 及时清理事件监听
- 避免内存泄漏
- 优化组件重渲染

## 未来规划

### 1. 功能增强

#### 高级变量
- 支持条件变量
- 变量计算和转换
- 动态变量生成

#### 集成功能
- 与 AI 服务集成
- 支持外部数据源
- 变量值验证和约束

### 2. 用户体验

#### 界面优化
- 拖拽式变量编辑
- 可视化变量关系
- 智能提示和建议

#### 协作功能
- 变量模板分享
- 团队协作编辑
- 版本控制和历史

## 总结

变量快捷编辑功能大大提升了 PromptMate 的实用性和效率，让用户可以：

1. **快速创建模板**: 通过变量占位符快速构建可复用的提示词模板
2. **智能填写**: 系统自动识别变量并提供智能建议和快速填充
3. **实时预览**: 填写变量后立即看到最终结果，提高工作效率
4. **历史管理**: 自动保存使用记录，支持快速复用和收藏

这些功能让提示词的创建和管理变得更加智能和便捷，为用户提供了更好的使用体验。 