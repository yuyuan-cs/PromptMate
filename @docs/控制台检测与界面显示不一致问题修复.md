# 控制台检测与界面显示不一致问题修复

## 问题描述

用户反馈：控制台检测到的分类ID和界面显示的分类不一样。

### 具体表现

- **控制台日志显示**：
  ```javascript
  categoryId: 'development'        // 开发编程
  categoryName: '开发编程'
  activeCategory: 'productivity'   // 生产力
  newPromptCategoryId: 'development'
  ```

- **界面显示**：分类下拉框显示"通用"（General）

- **期望结果**：界面应该显示"开发编程"（Development）

## 问题根因

经过分析发现，问题在于 **状态更新时机**：

1. **右键菜单正确传递**：`handleContextMenuNewPrompt('development')` 正确传递了分类ID
2. **状态正确设置**：`setNewPromptCategoryId('development')` 正确设置了状态
3. **对话框正确接收**：`defaultCategory: newPromptCategoryId` 正确传递了参数
4. **表单初始化问题**：`usePromptForm` 只在组件初始化时调用 `getInitialFormData()`，没有监听 `defaultCategory` 的变化

### 具体问题

在 `usePromptForm.ts` 中：

```typescript
// 只在组件初始化时调用一次
const [state, setState] = useState<PromptFormState>(() => ({
  ...getInitialFormData(),  // 这里 defaultCategory 可能还是 undefined
  // ...
}));

// 只监听 prompt 变化，不监听 defaultCategory 变化
useEffect(() => {
  if (mode === 'edit' && prompt) {
    // 只在编辑模式下重新初始化
  }
}, [prompt?.id, mode]);
```

当 `defaultCategory` 从 `undefined` 变为 `'development'` 时，表单状态没有重新初始化。

## 解决方案

### 添加 defaultCategory 监听

在 `usePromptForm.ts` 中添加了新的 `useEffect` 来监听 `defaultCategory` 的变化：

```typescript
// 监听 defaultCategory 变化，重新初始化表单数据（创建模式）
useEffect(() => {
  if (mode === 'create' && defaultCategory) {
    console.log('🔄 defaultCategory 变化，重新初始化表单:', {
      oldCategory: state.category,
      newDefaultCategory: defaultCategory,
      activeCategory
    });
    
    setState(prev => ({
      ...prev,
      category: defaultCategory,  // 更新分类
      hasChanges: false,
    }));
  }
}, [defaultCategory, mode]);
```

### 修复逻辑

1. **监听 defaultCategory 变化**：当 `defaultCategory` 从 `undefined` 变为具体值时触发
2. **仅在创建模式下生效**：避免在编辑模式下干扰原有逻辑
3. **更新分类字段**：直接设置 `category: defaultCategory`
4. **重置变更状态**：设置 `hasChanges: false`

## 修复效果

修复后的行为：

1. **右键菜单触发**：`handleContextMenuNewPrompt('development')`
2. **状态更新**：`setNewPromptCategoryId('development')`
3. **对话框打开**：`defaultCategory: 'development'`
4. **表单监听**：`useEffect` 检测到 `defaultCategory` 变化
5. **状态更新**：`setState({ category: 'development' })`
6. **界面更新**：分类下拉框显示"开发编程"

## 调试日志

添加了详细的调试日志：

```typescript
console.log('🔄 defaultCategory 变化，重新初始化表单:', {
  oldCategory: state.category,        // 旧的分类
  newDefaultCategory: defaultCategory, // 新的默认分类
  activeCategory                      // 当前激活分类
});
```

## 测试步骤

### 测试场景1：悬浮右键点击未激活分类
1. 确保没有分类被激活
2. 鼠标悬浮在"开发编程"分类上
3. 右键点击，选择"新建提示词"
4. 检查控制台日志：
   - 应该看到 `🔄 defaultCategory 变化，重新初始化表单` 日志
   - `oldCategory` 应该是初始值
   - `newDefaultCategory` 应该是 "development"
5. 检查界面：分类下拉框应该显示"开发编程"

### 测试场景2：悬浮右键点击与激活分类不同的分类
1. 先点击激活"生产力"分类
2. 鼠标悬浮在"创意生成"分类上
3. 右键点击，选择"新建提示词"
4. 检查控制台日志和界面显示

## 相关文件

- `src/hooks/usePromptForm.ts` - 表单管理Hook（主要修复）
- `src/components/Sidebar.tsx` - 侧边栏组件（右键菜单）
- `src/components/CreatePromptDialog.tsx` - 新建提示词对话框

## 更新日期

2025-01-27


