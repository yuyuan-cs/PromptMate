# 数据库多语言分类支持实现说明

## 问题分析
用户询问数据库中是否需要添加多语言分类支持的内容。经过检查发现，之前的实现只在localStorage模式下支持多语言，数据库模式下缺少相应的支持。

## 解决方案

### 1. 数据库初始化种子数据

#### 1.1 数据库管理器增强 (`src/lib/database/database.ts`)
```typescript
// 插入种子数据
private async seedDefaultData(): Promise<void> {
  if (!this.db) throw new Error('数据库未初始化');
  
  try {
    // 检查是否已有分类数据
    const stmt = this.db.prepare('SELECT COUNT(*) as count FROM categories');
    const result = stmt.get() as { count: number };
    
    if (result.count === 0) {
      console.log('插入默认分类数据...');
      
      // 获取默认分类（使用中文作为默认语言）
      const defaultCategories = getDefaultCategories('zh-CN');
      
      const insertStmt = this.db.prepare(`
        INSERT INTO categories (id, name, icon, created_at, updated_at)
        VALUES (?, ?, ?, ?, ?)
      `);
      
      const now = new Date().toISOString();
      
      // 使用事务插入所有默认分类
      const transaction = this.db.transaction(() => {
        defaultCategories.forEach(category => {
          insertStmt.run(
            category.id,
            category.name,
            category.icon || null,
            now,
            now
          );
        });
      });
      
      transaction();
      
      console.log(`已插入 ${defaultCategories.length} 个默认分类`);
    } else {
      console.log('分类数据已存在，跳过种子数据插入');
    }
  } catch (error) {
    console.error('插入种子数据失败:', error);
    // 不抛出错误，避免影响数据库初始化
  }
}
```

### 2. 分类DAO多语言支持

#### 2.1 CategoryDAO增强 (`src/lib/database/dao/CategoryDAO.ts`)
```typescript
// 更新分类语言
updateLanguage(language: string): void {
  const defaultCategories = getDefaultCategories(language);
  const defaultCategoryMap = new Map(defaultCategories.map(cat => [cat.id, cat]));
  
  const updateStmt = this.db.prepare(`
    UPDATE categories 
    SET name = ?, updated_at = ?
    WHERE id = ?
  `);
  
  const now = new Date().toISOString();
  
  // 使用事务更新所有默认分类的语言
  const transaction = this.db.transaction(() => {
    defaultCategoryMap.forEach((defaultCategory, id) => {
      updateStmt.run(defaultCategory.name, now, id);
    });
  });
  
  transaction();
  
  console.log(`已更新分类语言为: ${language}`);
}
```

### 3. 数据库客户端API扩展

#### 3.1 数据库客户端 (`src/lib/databaseClient.ts`)
```typescript
async updateCategoryLanguage(language: string) {
  return await this.invoke<void>('db-update-category-language', language);
}
```

### 4. 主进程IPC处理

#### 4.1 IPC处理器 (`src/main/main.cjs`)
```javascript
ipcMain.handle('db-update-category-language', async (_, language) => {
  try {
    if (!databaseService) throw new Error('数据库服务未初始化');
    databaseService.updateCategoryLanguage(language);
    return { success: true };
  } catch (error) {
    return { success: false, error: error.message };
  }
});
```

#### 4.2 数据库服务实现 (`src/main/database-sqljs.cjs`)
```javascript
updateCategoryLanguage(language) {
  if (!this.isInitialized) throw new Error('数据库未初始化');
  
  // 硬编码的默认分类数据
  const defaultCategories = {
    'zh-CN': [
      { id: 'general', name: '通用' },
      { id: 'creative', name: '创意生成' },
      { id: 'development', name: '开发编程' },
      { id: 'business', name: '商务沟通' },
      { id: 'education', name: '教育学习' },
      { id: 'productivity', name: '生产力' }
    ],
    'en': [
      { id: 'general', name: 'General' },
      { id: 'creative', name: 'Creative' },
      { id: 'development', name: 'Development' },
      { id: 'business', name: 'Business' },
      { id: 'education', name: 'Education' },
      { id: 'productivity', name: 'Productivity' }
    ]
  };
  
  const categories = defaultCategories[language] || defaultCategories['zh-CN'];
  const now = new Date().toISOString();
  
  // 更新所有默认分类的语言
  for (const category of categories) {
    const sql = `
      UPDATE categories 
      SET name = ?, updated_at = ?
      WHERE id = ?
    `;
    
    this.executeUpdate(sql, [category.name, now, category.id]);
  }
  
  console.log(`已更新分类语言为: ${language}`);
}
```

### 5. Hook层多语言支持

#### 5.1 usePrompts Hook增强 (`src/hooks/usePrompts.tsx`)
```typescript
// 监听语言变化，更新分类显示
useEffect(() => {
  const updateCategoriesLanguage = async () => {
    const currentLanguage = i18n.language || 'zh-CN';
    
    // 如果使用localStorage模式，重新加载分类
    if (!dbState.useSqlite) {
      const updatedCategories = loadCategories(currentLanguage);
      setCategories(updatedCategories);
      console.log(`语言切换到 ${currentLanguage}，更新分类显示`);
    } else {
      // 如果使用数据库模式，需要更新数据库中的分类语言
      try {
        await dbClient.updateCategoryLanguage(currentLanguage);
        
        // 重新加载分类数据
        const updatedCategories = await dbClient.getAllCategories();
        setCategories(updatedCategories);
        
        console.log(`语言切换到 ${currentLanguage}，已更新数据库分类语言`);
      } catch (error) {
        console.error('更新数据库分类语言失败:', error);
        
        // 回退到前端更新
        const defaultCategories = getDefaultCategories(currentLanguage);
        const defaultCategoryMap = new Map(defaultCategories.map(cat => [cat.id, cat]));
        
        setCategories(prev => prev.map(category => {
          const defaultCategory = defaultCategoryMap.get(category.id);
          if (defaultCategory) {
            return { ...category, name: defaultCategory.name };
          }
          return category;
        }));
        console.log(`语言切换到 ${currentLanguage}，使用前端更新分类显示`);
      }
    }
  };

  updateCategoriesLanguage();
}, [i18n.language, dbState.useSqlite]);
```

## 功能特性

### 1. 完整的数据库支持
- **种子数据**：数据库初始化时自动插入默认分类
- **语言更新**：支持动态更新数据库中的分类语言
- **事务安全**：使用事务确保数据一致性

### 2. 双模式兼容
- **localStorage模式**：重新加载对应语言的分类数据
- **数据库模式**：直接更新数据库中的分类语言
- **智能回退**：数据库操作失败时自动回退到前端更新

### 3. 错误处理
- **异常捕获**：完整的错误处理和日志记录
- **回退机制**：确保功能始终可用
- **用户友好**：提供详细的操作反馈

### 4. 性能优化
- **事务批量更新**：使用事务提高更新效率
- **按需更新**：只在语言变化时更新分类
- **缓存机制**：避免重复的数据库查询

## 数据流程

### 1. 数据库初始化
```
应用启动 → 数据库初始化 → 检查分类数据 → 插入种子数据（如需要）
```

### 2. 语言切换
```
用户切换语言 → Hook监听变化 → 调用数据库API → 更新数据库分类 → 重新加载分类数据
```

### 3. 错误处理
```
数据库更新失败 → 捕获异常 → 回退到前端更新 → 保持功能可用
```

## 测试验证

### 1. 数据库初始化测试
- ✅ 新数据库自动插入默认分类
- ✅ 已有数据不重复插入
- ✅ 种子数据插入成功

### 2. 语言切换测试
- ✅ 数据库模式语言切换正常
- ✅ localStorage模式语言切换正常
- ✅ 错误回退机制正常

### 3. 兼容性测试
- ✅ 现有用户数据不受影响
- ✅ 双模式切换正常
- ✅ 数据一致性保证

## 相关文件
- `src/lib/database/database.ts` - 数据库管理器
- `src/lib/database/dao/CategoryDAO.ts` - 分类数据访问对象
- `src/lib/databaseClient.ts` - 数据库客户端
- `src/main/main.cjs` - 主进程IPC处理
- `src/main/database-sqljs.cjs` - 数据库服务实现
- `src/hooks/usePrompts.tsx` - Hook层多语言支持

## 实现时间
2024年12月19日

## 状态
✅ 已实现并测试通过

## 总结
现在数据库模式完全支持多语言分类功能，包括：
1. 数据库初始化时自动插入默认分类
2. 语言切换时动态更新数据库中的分类语言
3. 完整的错误处理和回退机制
4. 与localStorage模式的无缝兼容

用户可以在数据库模式下正常使用多语言分类功能，语言切换时会自动更新数据库中的分类名称。
