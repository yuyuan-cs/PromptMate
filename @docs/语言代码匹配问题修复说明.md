# 语言代码匹配问题修复说明

## 问题分析
用户反馈语言切换后还是只显示中文，经过检查发现问题是语言代码不匹配：

1. **i18n配置**：使用 `'en-US'` 作为英文语言代码
2. **数据文件**：使用 `'en'` 作为英文语言代码
3. **语言检测**：由于代码不匹配，导致英文数据无法正确加载

## 问题根源

### 1. i18n配置 (`src/i18n/index.ts`)
```typescript
const resources = {
  'zh-CN': {
    translation: zhCN
  },
  'en-US': {  // ← 使用 'en-US'
    translation: enUS
  }
};
```

### 2. 数据加载函数 (`src/lib/data.ts`)
```typescript
// 修复前
export const getDefaultCategories = (language: string = 'zh-CN'): Category[] => {
  return language === 'en' ? defaultCategoriesEn : defaultCategoriesZh;  // ← 使用 'en'
};

export const getSamplePrompts = (language: string = 'zh-CN'): Prompt[] => {
  const promptsData = language === 'en' ? samplePromptsDataEn : samplePromptsDataZh;  // ← 使用 'en'
  return promptsData.map(p => ({
    ...p,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
  }));
};
```

### 3. 数据库服务 (`src/main/database-sqljs.cjs`)
```javascript
// 修复前
const defaultCategories = {
  'zh-CN': [...],
  'en': [...]  // ← 使用 'en'
};

const samplePrompts = {
  'zh-CN': [...],
  'en': [...]  // ← 使用 'en'
};
```

## 修复方案

### 1. 数据加载函数修复 (`src/lib/data.ts`)
```typescript
// 修复后
export const getDefaultCategories = (language: string = 'zh-CN'): Category[] => {
  return language === 'en-US' ? defaultCategoriesEn : defaultCategoriesZh;  // ← 改为 'en-US'
};

export const getSamplePrompts = (language: string = 'zh-CN'): Prompt[] => {
  const promptsData = language === 'en-US' ? samplePromptsDataEn : samplePromptsDataZh;  // ← 改为 'en-US'
  return promptsData.map(p => ({
    ...p,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
  }));
};
```

### 2. 数据库服务修复 (`src/main/database-sqljs.cjs`)
```javascript
// 修复后
const defaultCategories = {
  'zh-CN': [
    { id: 'general', name: '通用' },
    { id: 'creative', name: '创意生成' },
    { id: 'development', name: '开发编程' },
    { id: 'business', name: '商务沟通' },
    { id: 'education', name: '教育学习' },
    { id: 'productivity', name: '生产力' }
  ],
  'en-US': [  // ← 改为 'en-US'
    { id: 'general', name: 'General' },
    { id: 'creative', name: 'Creative' },
    { id: 'development', name: 'Development' },
    { id: 'business', name: 'Business' },
    { id: 'education', name: 'Education' },
    { id: 'productivity', name: 'Productivity' }
  ]
};

const samplePrompts = {
  'zh-CN': [
    { id: '1', title: '代码解释器', content: '...', tags: ['代码', '解释', '编程'] },
    // ... 更多中文提示词
  ],
  'en-US': [  // ← 改为 'en-US'
    { id: '1', title: 'Code Interpreter', content: '...', tags: ['code', 'explanation', 'programming'] },
    // ... 更多英文提示词
  ]
};
```

### 3. 调试信息增强 (`src/hooks/usePrompts.tsx`)
```typescript
// 监听语言变化，更新分类显示
useEffect(() => {
  const currentLanguage = i18n.language || 'zh-CN';
  console.log(`🌐 语言变化检测: ${currentLanguage}, 数据库模式: ${dbState.useSqlite}`);
  
  // 如果使用localStorage模式，重新加载分类和提示词
  if (!dbState.useSqlite) {
    const updatedCategories = loadCategories(currentLanguage);
    const updatedPrompts = loadPrompts(currentLanguage);
    setCategories(updatedCategories);
    setPrompts(updatedPrompts);
    console.log(`📱 localStorage模式: 语言切换到 ${currentLanguage}，更新分类和提示词显示`);
    console.log(`📊 分类数量: ${updatedCategories.length}, 提示词数量: ${updatedPrompts.length}`);
  } else {
    // 数据库模式处理...
    console.log(`🗄️ 数据库模式: 语言切换到 ${currentLanguage}，已更新数据库分类和提示词语言`);
    console.log(`📊 分类数量: ${updatedCategories.length}, 提示词数量: ${updatedPrompts.length}`);
  }
}, [i18n.language, dbState.useSqlite]);
```

## 语言代码统一

### 统一后的语言代码映射
| 组件 | 语言代码 | 说明 |
|------|----------|------|
| i18n配置 | `'zh-CN'` | 中文（简体） |
| i18n配置 | `'en-US'` | 英文（美式） |
| 数据文件 | `'zh-CN'` | 中文数据 |
| 数据文件 | `'en-US'` | 英文数据 |
| 数据库 | `'zh-CN'` | 中文数据 |
| 数据库 | `'en-US'` | 英文数据 |

### 语言检测流程
```
用户选择语言 → LanguageSelector → i18n.changeLanguage('en-US') → 
useEffect监听 → 检测到语言变化 → 调用对应数据加载函数 → 
根据 'en-US' 加载英文数据 → 更新显示
```

## 测试验证

### 1. 语言切换测试
- ✅ 中文模式：显示中文分类和提示词
- ✅ 英文模式：显示英文分类和提示词
- ✅ 语言代码匹配：`'en-US'` 正确映射到英文数据

### 2. 数据一致性测试
- ✅ localStorage模式：语言切换正常
- ✅ 数据库模式：语言切换正常
- ✅ 分类名称：正确显示对应语言
- ✅ 提示词内容：正确显示对应语言
- ✅ 标签名称：正确显示对应语言

### 3. 调试信息验证
- ✅ 控制台显示语言变化检测
- ✅ 显示当前使用的数据模式
- ✅ 显示加载的数据数量

## 相关文件
- `src/i18n/index.ts` - i18n配置
- `src/components/ui/LanguageSelector.tsx` - 语言选择器
- `src/lib/data.ts` - 数据加载函数
- `src/main/database-sqljs.cjs` - 数据库服务
- `src/hooks/usePrompts.tsx` - Hook层语言处理

## 实现时间
2024年12月19日

## 状态
✅ 已修复并测试通过

## 总结
通过统一语言代码为 `'en-US'`，现在语言切换功能完全正常：

1. **语言代码统一**：所有组件使用相同的语言代码
2. **数据映射正确**：英文数据正确加载和显示
3. **调试信息完善**：便于问题排查和验证
4. **双模式兼容**：localStorage和数据库模式都正常工作

用户现在可以正常切换语言，分类名称、提示词内容和标签都会正确显示对应语言的版本。
