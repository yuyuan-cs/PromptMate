# 多语言分类功能实现说明

## 功能概述
实现了分类文件夹的多语言支持，根据用户的语言设置自动显示对应语言的分类名称。

## 实现方案

### 1. 数据结构设计
- **默认分类数据**：分别存储中英文版本的分类数据
  - `src/data/categories.zh.json` - 中文分类
  - `src/data/categories.en.json` - 英文分类

### 2. 核心功能实现

#### 2.1 数据加载函数 (`src/lib/data.ts`)
```typescript
// 根据语言获取默认分类
export const getDefaultCategories = (language: string = 'zh-CN'): Category[] => {
  return language === 'en' ? defaultCategoriesEn : defaultCategoriesZh;
};

// 多语言分类加载
export const loadCategories = (language: string = 'zh-CN'): Category[] => {
  try {
    const saved = localStorage.getItem(STORAGE_KEYS.CATEGORIES);
    if (saved) {
      const savedCategories = JSON.parse(saved);
      // 如果有保存的分类，检查是否需要更新语言
      return updateCategoriesLanguage(savedCategories, language);
    }
    return getDefaultCategories(language);
  } catch (error) {
    console.error("加载分类时出错:", error);
    return getDefaultCategories(language);
  }
};

// 更新分类语言
const updateCategoriesLanguage = (categories: Category[], targetLanguage: string): Category[] => {
  const defaultCategories = getDefaultCategories(targetLanguage);
  
  // 创建默认分类的映射
  const defaultCategoryMap = new Map(defaultCategories.map(cat => [cat.id, cat]));
  
  // 更新现有分类的语言
  return categories.map(category => {
    const defaultCategory = defaultCategoryMap.get(category.id);
    if (defaultCategory) {
      // 如果是默认分类，使用对应语言的名称
      return {
        ...category,
        name: defaultCategory.name
      };
    }
    // 用户自定义分类保持原样
    return category;
  });
};
```

#### 2.2 Hook集成 (`src/hooks/usePrompts.tsx`)
```typescript
// 监听语言变化，更新分类显示
useEffect(() => {
  const currentLanguage = i18n.language || 'zh-CN';
  
  // 如果使用localStorage模式，重新加载分类
  if (!dbState.useSqlite) {
    const updatedCategories = loadCategories(currentLanguage);
    setCategories(updatedCategories);
    console.log(`语言切换到 ${currentLanguage}，更新分类显示`);
  } else {
    // 如果使用数据库模式，需要更新分类语言
    const defaultCategories = getDefaultCategories(currentLanguage);
    const defaultCategoryMap = new Map(defaultCategories.map(cat => [cat.id, cat]));
    
    setCategories(prev => prev.map(category => {
      const defaultCategory = defaultCategoryMap.get(category.id);
      if (defaultCategory) {
        return { ...category, name: defaultCategory.name };
      }
      return category;
    }));
    console.log(`语言切换到 ${currentLanguage}，更新数据库分类显示`);
  }
}, [i18n.language, dbState.useSqlite]);
```

## 功能特性

### 1. 智能语言切换
- **自动检测**：根据 `i18n.language` 自动切换分类语言
- **实时更新**：语言切换时立即更新分类显示
- **无缝体验**：用户无需重启应用即可看到语言变化

### 2. 双模式支持
- **localStorage模式**：重新加载对应语言的分类数据
- **数据库模式**：动态更新现有分类的语言显示

### 3. 分类类型处理
- **默认分类**：自动使用对应语言的名称
- **用户自定义分类**：保持用户输入的名称不变

### 4. 数据兼容性
- **向后兼容**：现有用户数据不受影响
- **平滑迁移**：首次加载时自动更新语言显示

## 分类数据对比

### 中文分类 (categories.zh.json)
```json
[
  { "id": "general", "name": "通用", "icon": "layout" },
  { "id": "creative", "name": "创意生成", "icon": "palette" },
  { "id": "development", "name": "开发编程", "icon": "fileText" },
  { "id": "business", "name": "商务沟通", "icon": "file" },
  { "id": "education", "name": "教育学习", "icon": "fileUp" },
  { "id": "productivity", "name": "生产力", "icon": "settings" }
]
```

### 英文分类 (categories.en.json)
```json
[
  { "id": "general", "name": "General", "icon": "layout" },
  { "id": "creative", "name": "Creative", "icon": "palette" },
  { "id": "development", "name": "Development", "icon": "fileText" },
  { "id": "business", "name": "Business", "icon": "file" },
  { "id": "education", "name": "Education", "icon": "fileUp" },
  { "id": "productivity", "name": "Productivity", "icon": "settings" }
]
```

## 使用方式

### 1. 语言切换
用户可以通过应用设置切换语言，分类会自动更新显示：

1. 打开应用设置
2. 选择语言（中文/English）
3. 分类名称立即更新为对应语言

### 2. 新建分类
- 用户创建的自定义分类会保持用户输入的名称
- 不受语言切换影响

### 3. 数据存储
- **默认分类**：只存储ID，名称根据语言动态显示
- **自定义分类**：存储完整的分类信息

## 技术实现细节

### 1. 性能优化
- **映射缓存**：使用Map结构快速查找默认分类
- **按需更新**：只在语言变化时更新分类
- **内存效率**：避免重复创建对象

### 2. 错误处理
- **回退机制**：加载失败时使用默认分类
- **异常捕获**：完整的错误处理和日志记录

### 3. 类型安全
- **TypeScript支持**：完整的类型定义
- **编译检查**：确保类型正确性

## 测试验证

### 1. 功能测试
- ✅ 语言切换时分类名称正确更新
- ✅ 默认分类显示对应语言名称
- ✅ 用户自定义分类保持不变
- ✅ 数据加载和保存正常

### 2. 兼容性测试
- ✅ 现有用户数据正常加载
- ✅ 数据库和localStorage模式都支持
- ✅ 中英文切换流畅

## 相关文件
- `src/lib/data.ts` - 数据加载和语言处理逻辑
- `src/hooks/usePrompts.tsx` - Hook集成和状态管理
- `src/data/categories.zh.json` - 中文分类数据
- `src/data/categories.en.json` - 英文分类数据

## 实现时间
2024年12月19日

## 状态
✅ 已实现并测试通过
