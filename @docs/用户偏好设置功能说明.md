# 用户偏好设置功能说明

## 概述

PromptMate 的用户偏好设置功能允许用户自定义应用的界面、行为和功能，并提供完整的持久化存储和同步支持。用户的设置会在下次打开应用时自动恢复，确保个性化体验的连续性。

## 核心功能

### 1. 持久化存储

#### 多环境存储
- **桌面环境**：使用 `localStorage` 进行本地存储
- **浏览器扩展环境**：优先使用 `chrome.storage.local`，fallback 到 `localStorage`
- **存储键名**：`promptmate-user-preferences`

#### 存储策略
- 自动保存：设置更改时立即保存
- 深度合并：新设置与默认设置智能合并
- 版本兼容：向后兼容，新增设置项不影响现有数据

### 2. 偏好设置分类

#### 界面偏好 (UI)
```typescript
ui: {
  sidebarExpanded: boolean;     // 侧边栏展开状态
  sidebarWidth: number;         // 侧边栏宽度 (200-500px)
  theme: 'light' | 'dark' | 'system';  // 主题设置
  fontSize: number;             // 字体大小 (12-20px)
  font: string;                 // 字体族
}
```

#### 编辑器偏好 (Editor)
```typescript
editor: {
  lineNumbers: boolean;         // 显示行号
  wordWrap: boolean;           // 自动换行
  autoSave: boolean;           // 自动保存
  autoSaveInterval: number;    // 自动保存间隔 (1-10秒)
}
```

#### 功能偏好 (Features)
```typescript
features: {
  showPreviewByDefault: boolean;      // 默认显示预览
  enableVariableHighlight: boolean;   // 启用变量高亮
  enableAutoComplete: boolean;        // 启用自动完成
  enableTooltips: boolean;           // 显示工具提示
}
```

#### 同步偏好 (Sync)
```typescript
sync: {
  autoSync: boolean;             // 自动同步
  syncInterval: number;          // 同步间隔
  includePreferences: boolean;   // 同步时包含偏好设置
}
```

### 3. 实时同步机制

#### 界面元素同步
- **侧边栏状态**：展开/折叠状态实时同步到偏好设置
- **侧边栏宽度**：拖拽调整后自动保存
- **主题切换**：主题变更同时更新偏好设置和界面设置

#### 双向绑定
- 偏好设置更改 → 界面立即更新
- 界面操作 → 偏好设置自动保存

### 4. 数据导出导入集成

#### 导出功能增强
```json
{
  "prompts": [...],
  "categories": [...],
  "settings": {...},
  "userPreferences": {
    "ui": {...},
    "editor": {...},
    "features": {...},
    "sync": {...}
  },
  "exportDate": "2024-01-01T00:00:00.000Z"
}
```

#### 导入功能增强
- 自动识别偏好设置数据
- 智能合并：保留用户当前偏好的同时导入新设置
- 向后兼容：支持没有偏好设置的旧版本数据

## 技术实现

### 1. useUserPreferences Hook

#### 核心接口
```typescript
export function useUserPreferences() {
  return {
    preferences: UserPreferences;              // 当前偏好设置
    loading: boolean;                          // 加载状态
    error: string | null;                      // 错误信息
    updatePreference: (category, updates) => Promise<boolean>;  // 更新特定分类
    savePreferences: (newPreferences) => Promise<boolean>;      // 保存完整偏好
    resetPreferences: () => Promise<boolean>;                   // 重置为默认
    exportPreferences: () => string;                            // 导出为JSON
    importPreferences: (data) => Promise<boolean>;              // 导入JSON数据
    loadPreferences: () => Promise<void>;                       // 重新加载
  };
}
```

#### 特性
- **类型安全**：完整的 TypeScript 类型定义
- **异步操作**：所有存储操作都是异步的
- **错误处理**：完善的错误捕获和用户反馈
- **性能优化**：避免不必要的重渲染

### 2. 存储管理

#### 数据结构设计
```typescript
interface UserPreferences {
  ui: UIPreferences;
  editor: EditorPreferences;
  features: FeaturePreferences;
  sync: SyncPreferences;
}
```

#### 默认值策略
- 提供完整的默认配置
- 新增设置项自动获得默认值
- 向后兼容旧版本数据

### 3. 组件集成

#### Sidebar 组件增强
- 添加偏好设置管理 Hook
- 实时响应偏好设置变化
- 双向同步侧边栏状态和偏好设置

#### PreferencesPanel 组件
- 分类清晰的设置界面
- 实时预览设置效果
- 支持导入导出偏好设置

## 用户界面

### 1. 设置面板导航

#### 新增偏好设置选项卡
- 位置：设置对话框中的第二个选项卡
- 图标：齿轮图标 (Settings)
- 标题：用户偏好设置

### 2. 偏好设置界面

#### 卡片式布局
```
┌─────────────────────────────────────┐
│ 界面偏好                            │
│ ├─ 侧边栏设置                       │
│ ├─ 主题设置                         │
│ └─ 字体设置                         │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 编辑器偏好                          │
│ ├─ 自动换行                         │
│ ├─ 自动保存                         │
│ └─ 保存间隔                         │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 功能偏好                            │
│ ├─ 默认显示预览                     │
│ ├─ 变量高亮                         │
│ ├─ 自动完成                         │
│ └─ 工具提示                         │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ 操作                                │
│ ├─ 导出偏好设置                     │
│ ├─ 导入偏好设置                     │
│ └─ 重置为默认                       │
└─────────────────────────────────────┘
```

#### 交互元素
- **开关控件**：用于布尔值设置
- **滑块控件**：用于数值范围设置
- **下拉选择**：用于枚举值选择
- **操作按钮**：导出、导入、重置功能

### 3. 实时反馈

#### 视觉反馈
- 设置更改时立即看到效果
- 保存状态的视觉提示
- 错误状态的友好提示

#### 操作确认
- 重置操作需要确认
- 导入操作显示成功/失败反馈
- 导出操作自动下载文件

## 使用场景

### 1. 首次使用

#### 默认体验
- 侧边栏默认展开 (280px)
- 跟随系统主题
- 启用所有功能特性
- 显示工具提示帮助

### 2. 个性化定制

#### 界面定制
```
用户操作：拖拽调整侧边栏宽度到 350px
系统响应：
  ├─ 界面立即调整宽度
  ├─ 偏好设置自动保存
  └─ 下次打开保持 350px
```

#### 主题切换
```
用户操作：点击主题切换按钮
系统响应：
  ├─ 界面立即切换主题
  ├─ 设置面板同步更新
  ├─ 偏好设置自动保存
  └─ 导出数据包含主题偏好
```

### 3. 数据迁移

#### 导出个人配置
```
操作流程：
  1. 设置 → 偏好设置 → 导出偏好设置
  2. 下载 promptmate-preferences-YYYY-MM-DD.json
  3. 在新设备上导入文件
  4. 所有个性化设置自动恢复
```

#### 团队配置共享
```
应用场景：
  ├─ 团队领导配置标准界面布局
  ├─ 导出偏好设置文件
  ├─ 团队成员导入统一配置
  └─ 保持团队界面一致性
```

## 兼容性

### 1. 向后兼容

#### 数据结构演进
- 新增设置项不影响现有数据
- 旧版本数据自动获得新设置的默认值
- 平滑升级用户体验

#### 导入兼容性
- 支持导入不包含偏好设置的旧版本数据
- 自动填充缺失的偏好设置项
- 错误容忍机制

### 2. 环境兼容

#### 存储适配
- 桌面应用：localStorage
- 浏览器扩展：chrome.storage.local + localStorage fallback
- 自动检测环境并选择最佳存储方案

#### 功能降级
- 不支持的功能自动禁用
- 保持核心功能可用
- 友好的错误提示

## 性能优化

### 1. 存储优化

#### 批量更新
- 合并连续的设置更改
- 减少存储操作频率
- 防抖机制避免过频保存

#### 内存管理
- 只在需要时加载偏好设置
- 及时清理事件监听器
- 避免内存泄漏

### 2. 渲染优化

#### React 优化
- 使用 useCallback 避免不必要的重渲染
- 分离不相关的状态更新
- 合理使用 useMemo 缓存计算结果

#### 界面响应
- 设置更改的即时视觉反馈
- 异步操作的加载状态
- 错误状态的用户友好提示

## 安全考虑

### 1. 数据验证

#### 输入验证
- 数值范围检查
- 类型安全验证
- 恶意数据过滤

#### 存储安全
- 本地存储加密（如需要）
- 数据完整性验证
- 防止数据损坏

### 2. 隐私保护

#### 数据最小化
- 只存储必要的偏好信息
- 不收集敏感用户数据
- 完全本地化存储

## 故障排除

### 1. 常见问题

#### 偏好设置丢失
```
问题：用户偏好设置在重启后丢失
原因：存储权限不足或数据损坏
解决：
  1. 检查浏览器存储权限
  2. 清除损坏的数据并重置
  3. 重新配置偏好设置
```

#### 导入失败
```
问题：导入偏好设置文件失败
原因：文件格式不正确或数据损坏
解决：
  1. 验证 JSON 文件格式
  2. 检查数据结构完整性
  3. 使用最近的备份文件
```

#### 界面异常
```
问题：设置更改后界面显示异常
原因：设置值超出有效范围
解决：
  1. 重置相关设置为默认值
  2. 检查设置范围限制
  3. 重新启动应用
```

### 2. 调试工具

#### 开发工具
- 浏览器控制台查看存储数据
- Network 面板监控存储操作
- React DevTools 检查组件状态

#### 诊断信息
```
存储检查：
  localStorage.getItem('promptmate-user-preferences')
  
状态检查：
  useUserPreferences() hook 状态
  
错误日志：
  控制台错误信息和堆栈追踪
```

## 未来扩展

### 1. 功能增强

#### 云端同步
- 支持跨设备偏好设置同步
- 用户账号体系集成
- 冲突解决机制

#### 预设配置
- 内置多种界面布局预设
- 一键切换工作模式
- 快速恢复特定配置

#### 智能推荐
- 基于使用习惯推荐设置
- 自动优化界面布局
- 个性化功能建议

### 2. 集成优化

#### 插件系统
- 第三方插件的偏好设置支持
- 插件配置的统一管理
- 插件间的设置共享

#### 团队协作
- 团队配置模板
- 配置版本管理
- 协作成员设置同步

## 总结

用户偏好设置功能为 PromptMate 提供了完整的个性化体验支持，通过以下关键特性提升用户体验：

1. **持久化存储**：确保用户设置在应用重启后保持
2. **实时同步**：界面操作与偏好设置双向同步
3. **导出导入**：支持配置备份和跨设备迁移
4. **类型安全**：完整的 TypeScript 支持和错误处理
5. **向后兼容**：平滑的版本升级体验
6. **性能优化**：高效的存储和渲染机制

这个系统为用户提供了灵活的自定义选项，同时保持了系统的稳定性和可维护性。


