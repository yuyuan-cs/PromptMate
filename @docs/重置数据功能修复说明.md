# 重置数据功能修复说明

## 问题描述

用户反馈：点击重置数据后，分类文件夹中的数据被删除了，但是全部提示词中仍然有被删除的内容。

## 问题分析

经过分析发现，问题在于当前的 `resetToDefaults` 函数只操作了 localStorage，但没有处理 SQLite 数据库。由于项目已经集成了 SQLite 数据库，当用户点击重置数据时，只清除了 localStorage 中的数据，但 SQLite 数据库中的提示词数据仍然存在。

## 解决方案

### 1. 数据库管理器增强

在 `src/lib/database/database.ts` 中添加了重置方法：

```typescript
// 清除所有数据
public clearAllData(): void {
  if (!this.db) throw new Error('数据库未初始化');
  
  try {
    const transaction = this.db.transaction(() => {
      // 删除所有表的数据，保持表结构
      this.db.exec('DELETE FROM prompt_tags');
      this.db.exec('DELETE FROM prompt_images');
      this.db.exec('DELETE FROM prompts');
      this.db.exec('DELETE FROM categories');
      this.db.exec('DELETE FROM tags');
      this.db.exec('DELETE FROM settings');
    });
    
    transaction();
    console.log('数据库数据清除成功');
  } catch (error) {
    console.error('清除数据库数据失败:', error);
    throw error;
  }
}

// 重置为默认数据
public resetToDefaults(language: string = 'zh-CN'): void {
  if (!this.db) throw new Error('数据库未初始化');
  
  try {
    // 先清除所有数据
    this.clearAllData();
    
    // 重新插入种子数据
    this.seedDefaultData();
    
    console.log('数据库重置为默认数据成功');
  } catch (error) {
    console.error('重置数据库为默认数据失败:', error);
    throw error;
  }
}
```

### 2. SQLite 服务增强

在 `src/main/database-sqljs.cjs` 中添加了对应的重置方法：

```javascript
// 清除所有数据
clearAllData() {
  if (!this.isInitialized) throw new Error('数据库未初始化');
  
  try {
    // 删除所有表的数据，保持表结构
    this.executeUpdate('DELETE FROM prompt_tags');
    this.executeUpdate('DELETE FROM prompt_images');
    this.executeUpdate('DELETE FROM prompts');
    this.executeUpdate('DELETE FROM categories');
    this.executeUpdate('DELETE FROM tags');
    this.executeUpdate('DELETE FROM settings');
    
    console.log('数据库数据清除成功');
  } catch (error) {
    console.error('清除数据库数据失败:', error);
    throw error;
  }
}

// 重置为默认数据
resetToDefaults(language = 'zh-CN') {
  if (!this.isInitialized) throw new Error('数据库未初始化');
  
  try {
    // 先清除所有数据
    this.clearAllData();
    
    // 重新插入默认分类和示例提示词
    // ... 详细实现见代码
    
    console.log('数据库重置为默认数据成功');
  } catch (error) {
    console.error('重置数据库为默认数据失败:', error);
    throw error;
  }
}
```

### 3. IPC 通信增强

在 `src/main/main.cjs` 中添加了 IPC 处理程序：

```javascript
// 数据库重置相关IPC处理程序
ipcMain.handle('db-clear-all-data', async () => {
  try {
    if (!databaseService) throw new Error('数据库服务未初始化');
    databaseService.clearAllData();
    return { success: true };
  } catch (error) {
    return { success: false, error: error.message };
  }
});

ipcMain.handle('db-reset-to-defaults', async (_, language = 'zh-CN') => {
  try {
    if (!databaseService) throw new Error('数据库服务未初始化');
    databaseService.resetToDefaults(language);
    return { success: true };
  } catch (error) {
    return { success: false, error: error.message };
  }
});
```

在 `src/main/preload.cjs` 中暴露了 API：

```javascript
// 数据库重置API
clearAllData: () => ipcRenderer.invoke('db-clear-all-data'),
resetToDefaults: (language) => ipcRenderer.invoke('db-reset-to-defaults', language),
```

### 4. 数据层更新

在 `src/lib/data.ts` 中更新了重置函数以支持双重重置：

```typescript
// 重置为默认数据
export const resetToDefaults = async (language: string = 'zh-CN'): Promise<void> => {
  try {
    // 重置 localStorage 数据
    savePrompts(samplePrompts);
    saveCategories(getDefaultCategories(language));
    saveSettings(defaultSettings);
    saveWorkflows([]);
    saveWorkflowExecutions([]);
    
    // 如果使用 SQLite 数据库，也重置数据库数据
    if (typeof window !== 'undefined' && (window as any).electronAPI?.resetToDefaults) {
      const result = await (window as any).electronAPI.resetToDefaults(language);
      if (!result.success) {
        console.error('重置数据库数据失败:', result.error);
      }
    }
  } catch (error) {
    console.error("重置为默认数据时出错:", error);
  }
};
```

### 5. UI 组件更新

在 `src/components/DataImportExport.tsx` 中更新了重置处理函数：

```typescript
// 重置为默认数据
const handleReset = async () => {
  try {
    await resetToDefaults();
    
    toast({
      title: t('dataManagement.message.resetSuccess'),
      description: t('dataManagement.message.resetSuccessData'),
      variant: "warning",
    });
    
    setShowConfirmReset(false);
    
    // 延迟触发数据变更回调，确保数据已保存
    setTimeout(() => {
      onDataChanged?.();
    }, 100);
    
    onOpenChange?.(false);
  } catch (error) {
    console.error('重置数据失败:', error);
    toast({
      title: t('dataManagement.message.resetError'),
      description: t('dataManagement.message.resetErrorData'),
      variant: "destructive",
    });
  }
};
```

## 修复效果

修复后的重置功能将：

1. **同时清除 localStorage 和 SQLite 数据库**：确保所有数据存储位置都被重置
2. **保持数据一致性**：避免出现分类被删除但提示词仍然存在的问题
3. **支持多语言**：重置时可以选择语言，插入对应语言的默认数据
4. **错误处理**：提供完善的错误处理和用户反馈
5. **向后兼容**：保持现有 API 的兼容性

## 测试建议

1. **功能测试**：
   - 创建一些自定义分类和提示词
   - 点击重置数据按钮
   - 验证分类和提示词都被正确清除
   - 验证默认数据被正确插入

2. **错误处理测试**：
   - 在数据库不可用时测试重置功能
   - 验证错误消息是否正确显示

3. **多语言测试**：
   - 在不同语言环境下测试重置功能
   - 验证默认数据是否使用正确的语言

## 相关文件

- `src/lib/database/database.ts` - 数据库管理器
- `src/main/database-sqljs.cjs` - SQLite 服务实现
- `src/main/main.cjs` - Electron 主进程
- `src/main/preload.cjs` - 预加载脚本
- `src/lib/data.ts` - 数据层
- `src/components/DataImportExport.tsx` - 数据管理组件

## 更新日期

2025-01-27

