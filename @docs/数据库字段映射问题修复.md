# 数据库字段映射问题修复说明

## 问题描述

在使用 sql.js 数据库时，出现字段映射不匹配的错误：

```
更新提示词失败: Error: no such column: isFavorite
```

## 问题根源

数据库 schema 和代码中字段名不一致：

### 数据库 Schema (schema.sql)
- `is_favorite` - 使用下划线命名 (snake_case)
- `category_id` - 使用下划线命名
- `created_at`, `updated_at` - 时间戳字段

### 代码中的字段名
- `isFavorite` - 使用驼峰命名 (camelCase)  
- `category` - 直接字段名
- 代码中还包含一些不存在的字段如 `rating`, `ratingNotes`, `description`

## 修复方案

### 1. 修复 `src/main/database-sqljs.cjs` 中的字段映射

#### A. 更新 `updatePrompt` 方法
```javascript
// 修复前
if (updates.category !== undefined) {
  fields.push('category = ?');          // ❌ 错误字段名
  values.push(updates.category);
}
if (updates.isFavorite !== undefined) {
  fields.push('isFavorite = ?');        // ❌ 错误字段名
  values.push(updates.isFavorite ? 1 : 0);
}

// 修复后  
if (updates.category !== undefined) {
  fields.push('category_id = ?');       // ✅ 正确字段名
  values.push(updates.category);
}
if (updates.isFavorite !== undefined) {
  fields.push('is_favorite = ?');       // ✅ 正确字段名
  values.push(updates.isFavorite ? 1 : 0);
}
```

#### B. 修复 `createPrompt` 方法
```javascript
// 修复前 - 包含不存在的字段
const insertPromptSql = `
  INSERT INTO prompts (id, title, content, category, description, isFavorite, rating, ratingNotes, version, created_at, updated_at)
  VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
`;

// 修复后 - 只使用存在的字段
const insertPromptSql = `
  INSERT INTO prompts (id, title, content, category_id, is_favorite, version, created_at, updated_at)
  VALUES (?, ?, ?, ?, ?, ?, ?, ?)
`;
```

#### C. 修复数据行映射函数
```javascript
// 修复前
isFavorite: Boolean(row.isFavorite)    // ❌ 从不存在的字段读取

// 修复后
isFavorite: Boolean(row.is_favorite)   // ✅ 从正确字段读取
```

### 2. 注释掉不存在的字段

对于 schema 中不存在的字段（`rating`, `ratingNotes`, `description`），已在代码中注释掉：

```javascript
// 注意：rating 和 ratingNotes 字段在当前 schema 中不存在
// 如果需要这些字段，需要先更新数据库 schema
// if (updates.rating !== undefined) {
//   fields.push('rating = ?');
//   values.push(updates.rating);
// }
```

## 字段映射对照表

| 代码字段 (camelCase) | 数据库字段 (snake_case) | 类型 | 说明 |
|-------------------|---------------------|------|------|
| `id` | `id` | TEXT | 主键 |
| `title` | `title` | TEXT | 标题 |
| `content` | `content` | TEXT | 内容 |
| `category` | `category_id` | TEXT | 分类ID |
| `isFavorite` | `is_favorite` | BOOLEAN | 是否收藏 |
| `version` | `version` | INTEGER | 版本号 |
| `tags` | - | - | 通过关联表处理 |
| `images` | - | - | 通过关联表处理 |

## 测试验证

修复后需要测试以下功能：
1. ✅ 创建新提示词
2. ✅ 更新提示词内容
3. ✅ 切换收藏状态
4. ✅ 修改分类
5. ✅ 数据正确保存和读取

## 注意事项

1. **字段一致性**：确保所有数据库操作使用正确的字段名
2. **Schema 同步**：如果需要添加新字段，先更新 schema.sql
3. **类型转换**：Boolean 值在 SQLite 中存储为 0/1，需要正确转换
4. **关联表**：tags 和 images 通过单独的关联表处理，不在主表中

## 相关文件

- `src/lib/database/schema.sql` - 数据库结构定义
- `src/main/database-sqljs.cjs` - sql.js 数据库服务 (主要修复文件)
- `src/lib/databaseClient.ts` - 数据库客户端 API
- `src/hooks/usePrompts.tsx` - 提示词管理 Hook

修复完成后，数据库操作应该能够正常工作，不再出现字段不存在的错误。
