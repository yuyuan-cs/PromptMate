# 系统字体检测功能实现说明

## 功能概述

为PromptMate添加了完整的系统字体检测功能，用户可以检测和选择系统中已安装的所有字体，提供更好的字体个性化体验。

## 实现细节

### 1. 技术方案

- **FontDetector类**: 单例模式的字体检测器
- **多检测方法**: FontFace API + Canvas检测 + 常用字体列表
- **字体分类**: 按类型自动分类字体
- **缓存机制**: 避免重复检测，提升性能

### 2. 核心组件

#### FontDetector类
```typescript
// 主要功能
- detectSystemFonts(): 检测系统字体
- categorizeFonts(): 按类型分类字体
- 多种检测方法组合
- 字体属性分析 (等宽、衬线等)
```

#### SystemFontSelector组件
```typescript
// 主要特性
- 字体检测和显示
- 分类浏览 (系统、衬线、无衬线、等宽等)
- 搜索和过滤功能
- 实时字体预览
- 响应式界面设计
```

### 3. 字体检测方法

#### 方法1: FontFace API (现代浏览器)
```typescript
// 使用现代浏览器的FontFace API
if ('fonts' in document && 'values' in document.fonts) {
  const fontFaceSet = await document.fonts.values();
  for (const fontFace of fontFaceSet) {
    fonts.push(this.fontFaceToSystemFont(fontFace));
  }
}
```

#### 方法2: Canvas检测 (兼容性更好)
```typescript
// 使用Canvas测量文本宽度检测字体
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');
ctx.font = `12px ${fontFamily}`;
const width = ctx.measureText(testText).width;
// 如果宽度与基线不同，说明字体已安装
```

#### 方法3: 常用字体列表
```typescript
// 预定义常用字体列表
const COMMON_FONTS = [
  'system-ui', 'PingFang SC', 'Microsoft YaHei',
  'Arial', 'Helvetica', 'Times New Roman',
  'Courier New', 'Consolas', 'Source Code Pro'
];
```

### 4. 字体分类系统

#### 分类类型
```typescript
export const FONT_CATEGORIES = {
  SYSTEM: 'System Fonts',        // 系统字体
  SERIF: 'Serif Fonts',          // 衬线字体
  SANS_SERIF: 'Sans Serif Fonts', // 无衬线字体
  MONOSPACE: 'Monospace Fonts',   // 等宽字体
  DISPLAY: 'Display Fonts',      // 装饰字体
  HANDWRITING: 'Handwriting Fonts', // 手写字体
  OTHER: 'Other Fonts'           // 其他字体
};
```

#### 字体属性检测
```typescript
// 字体类型判断
private isMonospace(fontFamily: string): boolean {
  const monospaceFonts = ['Courier New', 'Monaco', 'Consolas', 'Source Code Pro'];
  return monospaceFonts.some(font => 
    fontFamily.toLowerCase().includes(font.toLowerCase())
  );
}

private isSerif(fontFamily: string): boolean {
  const serifFonts = ['Times New Roman', 'Georgia', 'SimSun', 'KaiTi'];
  return serifFonts.some(font => 
    fontFamily.toLowerCase().includes(font.toLowerCase())
  );
}
```

### 5. 用户界面设计

#### 系统字体选择器界面
```tsx
// 主要界面元素
- 搜索框: 实时搜索字体
- 分类标签: 按类型浏览字体
- 字体列表: 显示字体名称和预览
- 状态徽章: 系统字体、等宽字体标识
- 预览文本: 实时字体效果预览
```

#### 集成到现有字体选择器
```tsx
// 在FontSelector中添加系统字体入口
<DropdownMenuItem onClick={() => setShowSystemFontSelector(true)}>
  <Monitor className="h-4 w-4" />
  {t('font.selectSystemFont')}
</DropdownMenuItem>
```

### 6. 性能优化

#### 缓存机制
```typescript
// 单例模式避免重复检测
private static instance: FontDetector;
private detectedFonts: SystemFont[] = [];
private isDetecting = false;

// 检测状态管理
async detectSystemFonts(): Promise<SystemFont[]> {
  if (this.detectedFonts.length > 0) {
    return this.detectedFonts; // 返回缓存结果
  }
  // 执行检测...
}
```

#### 异步检测
```typescript
// 非阻塞检测
const detectionPromise = this.performDetection();
this.isDetecting = true;

try {
  this.detectedFonts = await this.detectionPromise;
  return this.detectedFonts;
} finally {
  this.isDetecting = false;
}
```

### 7. 错误处理

#### 降级策略
```typescript
try {
  // 尝试多种检测方法
  const fontFaceSet = await document.fonts.values();
  const canvasFonts = await this.detectFontsWithCanvas();
  const commonFonts = await this.detectCommonFonts();
} catch (error) {
  console.warn('字体检测失败，使用默认字体列表:', error);
  return this.getDefaultFonts(); // 降级到默认字体
}
```

#### 用户反馈
```typescript
// 检测成功提示
toast({
  title: t('font.detectionSuccess'),
  description: t('font.detectionSuccessDesc', { count: detectedFonts.length }),
  variant: 'success'
});

// 检测失败提示
toast({
  title: t('font.detectionFailed'),
  description: t('font.detectionFailedDesc'),
  variant: 'destructive'
});
```

## 使用说明

### 基本操作
1. **打开字体选择器**: 点击字体下拉菜单
2. **选择系统字体**: 点击"选择系统字体"选项
3. **浏览字体**: 使用分类标签浏览不同类型字体
4. **搜索字体**: 在搜索框中输入字体名称
5. **预览字体**: 查看字体效果预览
6. **选择字体**: 点击字体项完成选择

### 字体分类
- **系统字体**: 操作系统默认字体
- **衬线字体**: 有装饰性笔画的字体
- **无衬线字体**: 简洁的现代字体
- **等宽字体**: 适合代码显示的字体
- **装饰字体**: 特殊用途的装饰性字体
- **手写字体**: 模拟手写效果的字体

### 搜索功能
- **实时搜索**: 输入时即时过滤结果
- **模糊匹配**: 支持部分匹配字体名称
- **多语言支持**: 支持中英文字体名称搜索

## 多语言支持

### 中文翻译
```json
{
  "font": {
    "selectSystemFont": "选择系统字体",
    "detectionSuccess": "字体检测成功",
    "detectionSuccessDesc": "检测到 {count} 个可用字体",
    "detectionFailed": "字体检测失败",
    "fontSelected": "字体已选择",
    "system": "系统",
    "monospace": "等宽",
    "search": "搜索字体",
    "category": {
      "systemfonts": "系统字体",
      "seriffonts": "衬线字体",
      "sansseriffonts": "无衬线字体",
      "monospacefonts": "等宽字体"
    }
  }
}
```

### 英文翻译
```json
{
  "font": {
    "selectSystemFont": "Select System Font",
    "detectionSuccess": "Font Detection Successful",
    "detectionSuccessDesc": "Detected {count} available fonts",
    "detectionFailed": "Font Detection Failed",
    "fontSelected": "Font Selected",
    "system": "System",
    "monospace": "Monospace",
    "search": "Search Fonts",
    "category": {
      "systemfonts": "System Fonts",
      "seriffonts": "Serif Fonts",
      "sansseriffonts": "Sans Serif Fonts",
      "monospacefonts": "Monospace Fonts"
    }
  }
}
```

## 技术优势

1. **兼容性强**: 多种检测方法确保在不同浏览器中工作
2. **性能优化**: 缓存机制避免重复检测
3. **用户体验**: 实时预览和分类浏览
4. **错误处理**: 完善的降级策略和用户反馈
5. **可扩展性**: 模块化设计易于扩展新功能
6. **多语言**: 完整的中英文支持

## 浏览器兼容性

### 支持的检测方法
- **FontFace API**: Chrome 37+, Firefox 41+, Safari 10+
- **Canvas检测**: 所有现代浏览器
- **常用字体列表**: 所有浏览器

### 降级策略
- 现代浏览器: 使用FontFace API + Canvas检测
- 旧版浏览器: 使用Canvas检测 + 常用字体列表
- 检测失败: 使用预定义字体列表

## 后续优化建议

1. **字体加载**: 支持Web字体的动态加载
2. **字体预览**: 添加更多预览文本选项
3. **字体收藏**: 允许用户收藏常用字体
4. **字体对比**: 支持多字体对比功能
5. **字体信息**: 显示字体的详细信息
6. **性能监控**: 添加字体检测性能指标

## 文件修改记录

- **新增文件**: 
  - `src/lib/fontDetector.ts` - 字体检测核心逻辑
  - `src/components/SystemFontSelector.tsx` - 系统字体选择器组件
- **修改文件**: 
  - `src/components/FontSelector.tsx` - 集成系统字体选择功能
  - `src/i18n/locales/zh-CN.json` - 添加中文翻译
  - `src/i18n/locales/en-US.json` - 添加英文翻译
- **修改时间**: 2024年12月
- **修改内容**: 添加完整的系统字体检测和选择功能
- **影响范围**: 字体选择功能，提升用户体验
