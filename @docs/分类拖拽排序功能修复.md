# 分类拖拽排序功能修复说明

## 问题描述

分类文件夹无法成功拖拽调整顺序，控制台报错：

```
react-dom.production.min.js:106 Uncaught TypeError: b is not a function
    at Sidebar.tsx:486:5
    at onDrop (Sidebar.tsx:744:44)
```

## 问题分析

### 错误位置

错误发生在 `src/components/Sidebar.tsx` 第486行：

```javascript
// 更新分类顺序
updateCategoriesOrder(newCategories);  // ← 这里报错
```

### 根本原因

在重构过程中，分类管理相关的函数被从 `usePrompts.tsx` 中移除了，但 `Sidebar.tsx` 组件仍在尝试使用这些函数：

#### 缺失的函数：
1. `updateCategoriesOrder` - 更新分类顺序
2. `updateCategory` - 更新分类信息  
3. `deleteCategory` - 删除分类

#### Sidebar.tsx 中的引用：
```javascript
const {
  // ... 其他属性
  updateCategory,        // ❌ 函数不存在
  deleteCategory,        // ❌ 函数不存在  
  updateCategoriesOrder, // ❌ 函数不存在
  // ... 其他属性
} = usePrompts();
```

## 修复方案

### 1. 恢复缺失的分类管理函数

在 `src/hooks/usePrompts.tsx` 中添加缺失的分类管理函数：

#### A. updateCategory 函数
```javascript
const updateCategory = useCallback((id: string, name: string, icon?: string) => {
  // 获取旧分类名称用于通知
  const oldCategory = categories.find(cat => cat.id === id);
  
  setCategories(prev => 
    prev.map(category => 
      category.id === id 
        ? { ...category, name, icon } 
        : category
    )
  );
  
  // 同时更新localStorage
  const updatedCategories = categories.map(category => 
    category.id === id 
      ? { ...category, name, icon } 
      : category
  );
  saveCategories(updatedCategories);
  
  toast({
    title: "分类已更新",
    description: `分类 "${oldCategory?.name || id}" 已更新`,
    variant: "success",
  });
}, [categories, toast]);
```

#### B. deleteCategory 函数
```javascript
const deleteCategory = useCallback((id: string) => {
  // 获取分类信息用于通知
  const categoryToDelete = categories.find(cat => cat.id === id);
  
  // 计算该分类下有多少提示词
  const promptsInCategory = prompts.filter(p => p.category === id).length;
  
  // 将该分类下的提示词移到"general"
  const updatedPrompts = prompts.map(prompt => 
    prompt.category === id 
      ? { ...prompt, category: "general" } 
      : prompt
  );
  setPrompts(updatedPrompts);
  savePrompts(updatedPrompts);
  
  const updatedCategories = categories.filter(category => category.id !== id);
  setCategories(updatedCategories);
  saveCategories(updatedCategories);
  
  if (activeCategory === id) {
    setActiveCategory(null);
  }
  
  toast({
    title: "分类已删除",
    description: promptsInCategory > 0 
      ? `分类 "${categoryToDelete?.name || id}" 已删除，${promptsInCategory} 个提示词已移至"通用"分类`
      : `分类 "${categoryToDelete?.name || id}" 已删除`,
    variant: "warning",
  });
}, [categories, prompts, activeCategory, toast]);
```

#### C. updateCategoriesOrder 函数
```javascript
const updateCategoriesOrder = useCallback((reorderedCategories: Category[]) => {
  setCategories(reorderedCategories);
  saveCategories(reorderedCategories);
  
  toast({
    title: "分类顺序已更新",
    description: "分类顺序已成功更新",
    variant: "success",
  });
}, [toast]);
```

### 2. 更新返回对象

在 `usePrompts.tsx` 的返回对象中添加分类管理函数：

```javascript
return {
  // ... 其他属性
  
  // 操作方法
  addPrompt,
  updatePrompt,
  deletePrompt,
  toggleFavorite,
  copyPromptContent,
  addFromRecommended,
  deleteTag,
  getTagsForCategory,
  
  // 分类管理
  updateCategory,           // ✅ 新增
  deleteCategory,           // ✅ 新增
  updateCategoriesOrder,    // ✅ 新增
  
  // ... 其他属性
};
```

## 功能验证

修复后，以下分类管理功能应该正常工作：

1. **拖拽排序** ✅
   - 可以拖拽分类改变顺序
   - 拖拽完成后显示成功通知
   - 分类顺序持久化保存

2. **分类编辑** ✅
   - 双击分类名称进入编辑模式
   - 可以修改分类名称和图标
   - 保存后显示更新通知

3. **分类删除** ✅
   - 可以删除自定义分类
   - 该分类下的提示词自动移至"通用"分类
   - 显示删除确认和结果通知

## 注意事项

1. **数据持久化**：所有分类操作都会同时更新内存状态和localStorage
2. **提示词迁移**：删除分类时，该分类下的提示词会自动移至"general"分类
3. **状态同步**：如果删除的是当前选中的分类，会自动清空选中状态
4. **用户体验**：所有操作都有相应的toast通知反馈

## 相关文件

- `src/hooks/usePrompts.tsx` - 主要修复文件，添加分类管理函数
- `src/components/Sidebar.tsx` - 使用分类管理函数的组件
- `src/lib/data.ts` - 提供 `saveCategories` 等数据持久化函数

修复完成后，分类拖拽排序功能应该完全恢复正常。
