# 鼠标悬浮右键点击分类识别测试说明

## 问题描述

用户反馈：鼠标悬浮在分类文件夹上右键点击时，有时候存在文件夹没有激活，只是鼠标悬浮至文件夹位置，然后新建提示词的情况。期望右键点击哪个分类，新建的提示词就应该属于哪个分类。

## 修复分析

### 代码流程分析

1. **右键菜单触发**：
   ```typescript
   <ContextMenuItem onClick={() => handleContextMenuNewPrompt(category.id)}>
   ```
   - 正确传递了被悬浮的分类ID (`category.id`)

2. **处理函数**：
   ```typescript
   const handleContextMenuNewPrompt = (categoryId: string) => {
     console.log('🔍 右键菜单新建提示词调试:', {
       categoryId,
       categoryName: categories.find(c => c.id === categoryId)?.name,
       activeCategory,
       newPromptCategoryId: categoryId
     });
     setNewPromptCategoryId(categoryId);
     setShowNewPromptDialog(true);
   };
   ```
   - 设置 `newPromptCategoryId` 为被悬浮的分类ID

3. **对话框调用**：
   ```typescript
   <CreatePromptDialog
     options={{
       defaultCategory: newPromptCategoryId || undefined,
       // ...
     }}
   />
   ```
   - 正确传递 `defaultCategory` 参数

4. **表单处理**：
   ```typescript
   const getDefaultCategory = () => {
     if (initialData?.category) return initialData.category;
     if (defaultCategory) return defaultCategory;  // 最高优先级
     if (activeCategory) return activeCategory;
     if (categories[0]?.id) return categories[0].id;
     return "general";
   };
   ```
   - `defaultCategory` 有最高优先级，应该正确工作

## 调试日志

添加了详细的调试日志来帮助诊断问题：

### 1. 右键菜单调试
```typescript
console.log('🔍 右键菜单新建提示词调试:', {
  categoryId,                    // 被右键点击的分类ID
  categoryName: categories.find(c => c.id === categoryId)?.name,  // 分类名称
  activeCategory,                // 当前激活的分类
  newPromptCategoryId: categoryId // 设置的新提示词分类ID
});
```

### 2. 表单初始化调试
```typescript
console.log('🔍 分类选择调试:', {
  initialDataCategory: initialData?.category,
  defaultCategory,               // 传递的默认分类
  activeCategory,                // 当前激活的分类
  firstCategory: categories[0]?.id,
  mode
});
```

## 测试步骤

### 测试场景1：悬浮右键点击未激活分类
1. 确保没有分类被激活（`activeCategory` 为 null）
2. 鼠标悬浮在"开发编程"分类上
3. 右键点击，选择"新建提示词"
4. 检查控制台日志：
   - `categoryId` 应该是 "development"
   - `defaultCategory` 应该是 "development"
   - 最终选择的分类应该是 "development"

### 测试场景2：悬浮右键点击与激活分类不同的分类
1. 先点击激活"通用"分类
2. 鼠标悬浮在"创意生成"分类上
3. 右键点击，选择"新建提示词"
4. 检查控制台日志：
   - `categoryId` 应该是 "creative"
   - `activeCategory` 应该是 "general"
   - `defaultCategory` 应该是 "creative"
   - 最终选择的分类应该是 "creative"

### 测试场景3：悬浮右键点击已激活的分类
1. 先点击激活"商务沟通"分类
2. 鼠标悬浮在"商务沟通"分类上
3. 右键点击，选择"新建提示词"
4. 检查控制台日志：
   - `categoryId` 应该是 "business"
   - `activeCategory` 应该是 "business"
   - `defaultCategory` 应该是 "business"
   - 最终选择的分类应该是 "business"

## 预期结果

所有测试场景都应该：
1. 右键菜单正确传递被悬浮的分类ID
2. 新建提示词对话框中的分类字段显示正确的分类
3. 创建的提示词属于正确的分类

## 可能的问题

如果测试失败，可能的原因：

1. **状态更新延迟**：`setNewPromptCategoryId` 可能没有及时更新
2. **组件重新渲染**：对话框可能在状态更新前就渲染了
3. **依赖项问题**：`usePromptForm` 的依赖项可能导致重新计算

## 解决方案

如果发现问题，可以考虑：

1. **使用 useEffect 监听状态变化**：
   ```typescript
   useEffect(() => {
     if (showNewPromptDialog && newPromptCategoryId) {
       // 确保状态已更新
     }
   }, [showNewPromptDialog, newPromptCategoryId]);
   ```

2. **直接传递分类ID**：
   ```typescript
   <CreatePromptDialog
     options={{
       defaultCategory: categoryId, // 直接传递，不依赖状态
     }}
   />
   ```

## 更新日期

2025-01-27

