# 右键菜单分类识别修复说明

## 问题描述

用户反馈：右键点击分类文件夹新建提示词时，识别的当前分类文件夹有误。

## 问题分析

经过分析发现，问题在于默认分类的逻辑优先级不正确：

### 原始问题代码

在 `src/hooks/usePromptForm.ts` 中：

```typescript
category: initialData?.category || defaultCategory || activeCategory || categories[0]?.id || "general",
```

在 `src/components/PromptList.tsx` 中：

```typescript
defaultCategory: activeCategory || categories[0]?.id || "general",
```

### 问题根因

1. **优先级错误**：`activeCategory` 的优先级高于 `defaultCategory`
2. **逻辑混乱**：当用户右键点击特定分类文件夹时，传递的 `defaultCategory` 被 `activeCategory` 覆盖
3. **用户体验差**：用户期望右键点击哪个分类，新建的提示词就应该属于哪个分类

## 解决方案

### 1. 修复 usePromptForm Hook

在 `src/hooks/usePromptForm.ts` 中重构了默认分类逻辑：

```typescript
// 修复默认分类逻辑：defaultCategory 应该有最高优先级
// 只有在没有指定 defaultCategory 时才使用 activeCategory
const getDefaultCategory = () => {
  if (initialData?.category) return initialData.category;
  if (defaultCategory) return defaultCategory;  // 最高优先级
  if (activeCategory) return activeCategory;
  if (categories[0]?.id) return categories[0].id;
  return "general";
};

return {
  title: initialData?.title || "",
  content: initialData?.content || "",
  category: getDefaultCategory(),  // 使用新的逻辑
  tags: initialData?.tags || "",
  images: initialData?.images || [],
  isFavorite: initialData?.isFavorite || false,
};
```

### 2. 修复 PromptList 组件

在 `src/components/PromptList.tsx` 中移除了 `activeCategory` 的优先级：

```typescript
// 修复前
defaultCategory: activeCategory || categories[0]?.id || "general",

// 修复后
defaultCategory: categories[0]?.id || "general",
```

## 修复效果

修复后的行为：

1. **右键菜单优先级**：右键点击分类文件夹时，新建提示词会正确使用该分类
2. **普通新建**：点击普通新建按钮时，使用第一个可用分类或默认分类
3. **编辑模式**：编辑现有提示词时，保持原有分类不变
4. **逻辑清晰**：分类优先级明确，不会出现意外的分类选择

## 分类优先级规则

修复后的分类优先级（从高到低）：

1. **initialData.category**：编辑模式时的原始分类
2. **defaultCategory**：通过参数明确指定的分类（如右键菜单）
3. **activeCategory**：当前激活的分类
4. **categories[0].id**：第一个可用分类
5. **"general"**：默认分类

## 测试场景

### 1. 右键菜单测试
- 右键点击"开发编程"分类
- 点击"新建提示词"
- 验证分类字段显示为"开发编程"

### 2. 普通新建测试
- 点击主界面的"新建提示词"按钮
- 验证分类字段显示为第一个可用分类

### 3. 编辑模式测试
- 编辑现有提示词
- 验证分类字段保持原有分类不变

## 相关文件

- `src/hooks/usePromptForm.ts` - 表单管理Hook
- `src/components/PromptList.tsx` - 提示词列表组件
- `src/components/Sidebar.tsx` - 侧边栏组件（右键菜单触发）

## 更新日期

2025-01-27
